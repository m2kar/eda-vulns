<!--
  CIRCT Bug Report
  Generated by circt-bug-reporter workflow
-->

<!-- Title: [Arc] Assertion failure in LowerState when processing modules with inout ports -->

## Description

arcilator crashes with an assertion failure when processing SystemVerilog modules containing `inout` ports. The crash occurs in the `LowerState` pass of the Arc dialect when attempting to create a `StateType` for an input that has type `!llhd.ref<i1>` (a reference type generated for inout ports).

The assertion failure message indicates: "state type must have a known bit width; got '!llhd.ref<i1>'"

**Crash Type**: assertion
**Dialect**: Arc
**Failing Pass**: LowerState

**Root Cause**: The Arc dialect's LowerState pass attempts to create `arc::StateType` for all module inputs, including those with `llhd::RefType` (generated from inout ports). However, `StateType::verify()` requires the wrapped type to have a known bit width, and `llhd::RefType` is a reference type that doesn't support bit width computation.

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   export PATH=/edazz/FeatureFuzz-SV/target/circt-1.139.0/bin:$PATH
   circt-verilog --ir-hw test.sv | arcilator
   ```

## Test Case

```systemverilog
module top(inout wire p);
endmodule
```

## Error Output

```
<unknown>:0: error: state type must have a known bit width; got '!llhd.ref<i1>'
arcilator: /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/StorageUniquerSupport.h:180: static ConcreteT mlir::detail::StorageUserBase<circt::arc::StateType, mlir::Type, circt::arc::detail::StateTypeStorage, mlir::detail::TypeUniquer>::get(MLIRContext *, Args &&...) [ConcreteT = circt::arc::StateType, BaseT = mlir::Type, StorageT = circt::arc::detail::StateTypeStorage, UniquerT = mlir::detail::TypeUniquer, Traits = <>, Args = <mlir::Type &>]: Assertion `succeeded( ConcreteT::verifyInvariants(getDefaultDiagnosticEmitFn(ctx), args...))' failed.
PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.
```

## Root Cause Analysis

### Background
When SystemVerilog `inout` ports are processed by `circt-verilog`, they are converted from HW dialect to Moore dialect, and then to Core dialect. During this conversion, `hw::InOutType` ports are represented as `!llhd.ref<T>` typed block arguments in the Core IR.

### The Problem
The `LowerState` pass in the Arc dialect (file: `LowerState.cpp:219`) attempts to create `arc::StateType` for all module inputs. However:

1. `StateType::verify()` requires the wrapped type to support `computeLLVMBitWidth()`
2. `llhd::RefType` is a reference/pointer type that does not have a fixed bit width
3. When `StateType::verify()` calls `computeLLVMBitWidth()` on a `RefType`, it fails the invariant check
4. This triggers an assertion failure rather than a graceful error message

### Evidence
- The crash occurs specifically when processing modules with `inout` ports
- The IR generated by `circt-verilog` correctly creates `!llhd.ref<i1>` type for the inout port
- Other tools (Verilator, Slang) accept this SystemVerilog code as valid
- Only `arcilator` crashes when processing the IR

### Suggested Fix
Add early detection in the `LowerState` pass to check for `llhd::RefType` before creating `StateType`. Emit a clear error message indicating that inout ports are not currently supported by arcilator, rather than triggering an assertion failure.

## Environment

- **CIRCT Version**: 1.139.0
- **OS**: Linux (kernel 5.15.0)
- **Architecture**: x86_64
- **Tool**: arcilator

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
#0 0x000055e1e6cb823f llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/lib/Support/Unix/Signals.inc:842:13
#1 0x000055e1e6cb9379 llvm::sys::RunSignalHandlers() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/lib/Support/Signals.cpp:109:18
#2 0x000055e1e6cb9379 SignalHandler(int, siginfo_t*, void*) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/lib/Support/Unix/Signals.inc:412:3
#11 0x000055e1e7409ae9 circt::arc::StateType::get(mlir::Type) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/build/tools/circt/include/circt/Dialect/Arc/ArcTypes.cpp.inc:108:3
#12 0x000055e1e7474f5c (anonymous namespace)::ModuleLowering::run() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Dialect/Arc/Transforms/LowerState.cpp:219:66
#13 0x000055e1e7474f5c (anonymous namespace)::LowerStatePass::runOnOperation() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Dialect/Arc/Transforms/LowerState.cpp:1198:41
#14 0x000055e1eae0b782 mlir::detail::OpToOpPassAdaptor::run(mlir::Pass*, mlir::Operation*, mlir::AnalysisManager, bool, unsigned int)::$_3::operator()() const /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/mlir/lib/Pass/Pass.cpp:0:19
#19 0x000055e1eadfe77f mlir::detail::OpToOpPassAdaptor::runPipeline(mlir::OpPassManager&, mlir::Operation*, mlir::AnalysisManager, bool, unsigned int, mlir::PassInstrumentor*, mlir::PassInstrumentation::PipelineParentInfo const*) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/mlir/lib/Pass/Pass.cpp:688:9
#20 0x000055e1eae081e9 mlir::PassManager::runPasses(mlir::Operation*, mlir::AnalysisManager) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/mlir/lib/Pass/Pass.cpp:1123:3
#21 0x000055e1eae07431 mlir::PassManager::run(mlir::Operation*) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/mlir/lib/Pass/Pass.cpp:1097:0
```

</details>

## Related Issues

**Note**: A very similar issue has already been reported:

- **#9574** - [Arc] Assertion failure when lowering inout ports in sequential logic
  - This issue appears to be the same bug (similarity score: 9.5/10.0)
  - Same error message, crash location, and root cause
  - Please review #9574 before proceeding with this report

**Additional Related Issues**:
- **#8825** - [LLHD] Switch from hw.inout to a custom signal reference type
  - Related to reference type handling and llhd.ref support
  - Different context but potentially connected to the same limitation

## Validation Results

| Tool | Result | Notes |
|------|--------|-------|
| Verilator | ✅ PASS | No errors or warnings |
| Slang | ✅ PASS | Build succeeded: 0 errors, 0 warnings |
| circt-verilog | ✅ PASS | Successfully generates MLIR IR with !llhd.ref<i1> type |
| arcilator | ❌ CRASH | SIGABRT - assertion failure in StateType::get() |

**Conclusion**: This is a valid SystemVerilog code that is accepted by multiple tools. The crash is specific to CIRCT's arcilator when processing modules with inout ports.

## Additional Information

- **Minimization**: The original 13-line test case was successfully reduced to just 2 lines (84.6% reduction)
- **Severity**: High - Any SystemVerilog module with inout ports cannot be processed by arcilator
- **Workaround**: Currently unknown; avoid using inout ports when targeting arcilator

---
*This issue was generated with assistance from an automated bug reporter workflow.*
