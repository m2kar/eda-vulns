<!--
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Moore] Assertion failure in SVModuleOpConversion when lowering packed union as module port -->

## Description

CIRCT's Moore dialect crashes when processing a SystemVerilog module that uses a packed union type as a module port. The crash occurs during the MooreToCore conversion pass in the `ModulePortInfo::sanitizeInOut()` function.

The issue is that `sanitizeInOut()` attempts to cast all port types to `hw::InOutType` using `dyn_cast`, but this fails when the port type is a Moore dialect `UnionType` that has not been properly converted to HW dialect.

**Crash Type**: assertion
**Dialect**: Moore
**Failing Pass**: SVModuleOpConversion

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv
   ```

## Test Case

```systemverilog
module m(
  input union packed { logic a; } u
);
endmodule
```

## Error Output

```
Crash Type: assertion
Testcase ID: 260128-00000717

--- Compilation Command ---
/edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/circt-verilog --ir-hw /tmp/featurefuzz_sv_xfhtv50x/test_5135d2254888.sv

--- Error Message ---
circt-verilog: /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/Support/Casting.h:650: decltype(auto) llvm::dyn_cast(From &) [To = circt::hw::InOutType, From = mlir::Type]: Assertion `detail::isPresent(Val) && "dyn_cast on a non-existent value"' failed.
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
...
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)
**Cause**: Missing type conversion pattern for `moore::UnionType` → HW dialect

**Evidence**:
1. Moore dialect correctly parses `packed union` as `moore::UnionType`
2. During Moore→Core conversion, `SVModuleOpConversion::matchAndRewrite` is invoked
3. `getModulePortInfo()` extracts port information and creates `ModulePortInfo`
4. `ModulePortInfo` constructor calls `sanitizeInOut()`
5. `sanitizeInOut()` iterates through ports and calls `dyn_cast<hw::InOutType>(p.type)`
6. When `p.type` is a `moore::UnionType`, the cast fails with assertion
7. The Moore dialect's `UnionType` is not properly converted to HW dialect before type checking

**Mechanism**:
```cpp
void sanitizeInOut() {
  for (auto &p : ports)
    if (auto inout = dyn_cast<hw::InOutType>(p.type)) {  // <-- CRASH HERE
      p.type = inout.getElementType();
      p.dir = ModulePort::Direction::InOut;
    }
}
```

The `dyn_cast` assertion fails because the type is not a valid `InOutType` - it's still a Moore dialect `UnionType`.

**Impact**:
- All SystemVerilog code using packed union types as module ports crashes
- This is a type system mismatch in the Moore→Core conversion

## Environment

- **CIRCT Version**: firtool-1.139.0
- **LLVM Version**: 22.0.0git
- **OS**: Linux
- **Architecture**: x86_64

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
Stack dump:
0.	Program arguments: /edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/circt-verilog --ir-hw /tmp/featurefuzz_sv_xfhtv50x/test_5135d2254888.sv
 #0 0x000056258ee1432f llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/lib/Support/Unix/Signals.inc:842:13
 #1 0x000056258ee152e9 llvm::sys::RunSignalHandlers() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/lib/Support/Signals.cpp:109:18
 #2 0x000056258ee152e9 SignalHandler(int, siginfo_t*, void*) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/lib/Support/Unix/Signals.inc:412:3
 #3 0x00007f204393b330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x000056258d58f874 mlir::TypeStorage::getAbstractType() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/TypeSupport.h:173:5
 #5 0x000056258d58f874 mlir::Type::getTypeID() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/Types.h:101:37
 #6 0x000056258d58f874 bool mlir::detail::StorageUserBase<circt::hw::InOutType, mlir::Type, circt::hw::detail::InOutTypeStorage, mlir::detail::TypeUniquer>::classof<mlir::Type>(mlir::Type) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/StorageUniquerSupport.h:113:16
 #7 0x000056258d58f874 llvm::CastInfo<circt::hw::InOutType, mlir::Type, void>::isPossible(mlir::Type) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/Types.h:374:14
 #8 0x000056258d58f874 llvm::DefaultDoCastIfPossible<circt::hw::InOutType, mlir::Type, llvm::CastInfo<circt::hw::InOutType, mlir::Type, void>>::doCastIfPossible(mlir::Type) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/Support/Casting.h:311:10
 #9 0x000056258d58f874 decltype(auto) llvm::dyn_cast<circt::hw::InOutType, mlir::Type>(mlir::Type&) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/Support/Casting.h:651:10
 #10 0x000056258d58f874 circt::hw::ModulePortInfo::sanitizeInOut() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/include/circt/Dialect/HW/PortImplementation.h:177:24
 #11 0x000056258d887753 llvm::SmallVectorTemplateCommon<circt::hw::PortInfo, void>::begin() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/ADT/SmallVector.h:271:45
 #12 0x000056258d887753 llvm::SmallVectorTemplateCommon<circt::hw::PortInfo, void>::end() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/ADT/SmallVector.h:273:27
 #13 0x000056258d887753 llvm::SmallVector<circt::hw::PortInfo, 1u>::~SmallVector() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/ADT/SmallVector.h:1209:46
 #14 0x000056258d887753 (anonymous namespace)::getModulePortInfo(mlir::TypeConverter const&, circt::moore::SVModuleOp) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Conversion/MooreToCore/MooreToCore.cpp:259:1
 #15 0x000056258d887753 (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Conversion/MooreToCore/MooreToCore.cpp:276:32
```

</details>

## Related Issues

- [#8930](https://github.com/llvm/circt/issues/8930): [MooreToCore] Crash with sqrt/floor - Same assertion message but different trigger
- [#8471](https://github.com/llvm/circt/issues/8471): [ImportVerilog] Union type in call - Related union type issue
- [#7378](https://github.com/llvm/circt/issues/7378): [HW] Roundtrip test fail for !hw.union - HW union type handling

## Additional Notes

1. **Minimization**: The original test case (28 lines) was reduced to 4 lines (85.7% reduction) while preserving the crash behavior.
2. **Validation**: Syntax validated with slang 10.0.6 (no errors).
3. **Reproducibility**: Crash is 100% reproducible with the minimal test case.
4. **Workaround**: Removing the union type or using a different type (e.g., plain `logic`) avoids the crash.

## Suggested Fix Areas

1. Add type conversion pattern for `moore::UnionType` → HW dialect
2. Update `sanitizeInOut()` to handle unexpected types gracefully
3. Add proper error reporting instead of assertion failure
4. Validate types before calling `dyn_cast` operations

---
*This issue was generated with assistance from an automated bug reporter.*