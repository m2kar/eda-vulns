<!-- 
  CIRCT Bug Analysis Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Arc] Analysis Report - Likely duplicate of #9574 (inout port assertion in LowerStatePass) -->

## ⚠️ Analysis Result: LIKELY DUPLICATE

**Status**: This bug has been analyzed and is **likely a duplicate** of an existing issue.

**Related Issue**: [#9574 - [Arc] Assertion failure when lowering inout ports in sequential logic](https://github.com/llvm/circt/issues/9574)

**Similarity Score**: 90.0%

---

## Description

This is an analysis report for a CIRCT crash in the Arc dialect. The original crash occurred in version 1.139.0 when processing SystemVerilog modules with `inout` ports through the `arcilator` tool.

**Note**: This bug **could not be reproduced** on the current toolchain (firtool-1.139.0 with LLVM 22.0.0git), suggesting it may have been fixed or the configuration differs.

### Crash Information

- **Crash Type**: assertion
- **Dialect**: Arc
- **Tool**: arcilator
- **Failing Pass**: LowerStatePass
- **Error Message**: `state type must have a known bit width; got '!llhd.ref<i1>'`

### Root Cause

The `LowerState` pass in Arc dialect attempts to create `StateType` for all module parameters. However, `StateType::verify()` calls `computeLLVMBitWidth()` which does not support `llhd::RefType` (used for bidirectional/inout ports). This causes assertion failure.

---

## Steps to Reproduce (Original)

**Note**: These steps are from the original bug report. The crash could not be reproduced on the current toolchain.

1. Save test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv | arcilator
   ```

---

## Test Case

```systemverilog
module test_module (
  input logic clk,
  output logic out,
  inout logic port_a,
  inout logic port_b
);

  logic sig;

  assign port_a = sig;
  assign port_b = sig;

  always @(posedge clk) begin
    sig = out;
  end

  always_comb begin
    out = ~sig;
  end

endmodule
```

---

## Error Output (Original)

```
<unknown>:0: error: state type must have a known bit width; got '!llhd.ref<i1>'
arcilator: /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/StorageUniquerSupport.h:180: static ConcreteT mlir::detail::StorageUserBase<circt::arc::StateType, mlir::Type, circt::arc::detail::StateTypeStorage, mlir::detail::TypeUniquer>::get(MLIRContext *, Args &&...) [ConcreteT = circt::arc::StateType, BaseT = mlir::Type, StorageT = circt::arc::detail::StateTypeStorage, UniquerT = mlir::detail::TypeUniquer, Traits = <>, Args = <mlir::Type &>]: Assertion `succeeded( ConcreteT::verifyInvariants(getDefaultDiagnosticEmitFn(ctx), args...))' failed.
...
```

---

## Root Cause Analysis

### Technical Details

**Category**: Missing type handler

**Problem**: `computeLLVMBitWidth()` in `lib/Dialect/Arc/ArcTypes.cpp` does not handle `llhd::RefType`, causing `StateType` verification to fail for bidirectional (inout) ports.

**Unsupported Type**: `!llhd.ref<i1>`

**Trigger Construct**: `inout logic port_a` in SystemVerilog

### Stack Trace (Original)

<details>
<summary>Click to expand stack trace</summary>

```
#0  llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
#1  llvm::sys::RunSignalHandlers()
#12 circt::arc::StateType::get(mlir::Type) at ArcTypes.cpp.inc:108
#13 (anonymous namespace)::ModuleLowering::run() at LowerState.cpp:219
#14 (anonymous namespace)::LowerStatePass::runOnOperation() at LowerState.cpp:1198
...
```

</details>

### Suggested Fixes

1. **Add type handler**: Handle `llhd::RefType` in `computeLLVMBitWidth()` to return nested type's bit width
2. **Special handling**: Handle inout ports specially rather than creating StateType directly
3. **Early validation**: Add pre-pass validation to detect unsupported inout ports with clear diagnostic

---

## Environment

### Original Environment
- **CIRCT Version**: circt-1.139.0
- **Path**: /edazz/FeatureFuzz-SV/target/circt-1.139.0/

### Reproduction Environment
- **CIRCT Version**: firtool-1.139.0
- **LLVM Version**: 22.0.0git
- **OS**: Linux 5.15.0-164-generic
- **Architecture**: x86_64
- **Reproduction Result**: NOT REPRODUCED (Bug may be fixed)

---

## Duplicate Analysis

This bug was checked against existing GitHub Issues in llvm/circt repository.

### Search Results

| Issue # | Similarity | Title | Status |
|---------|------------|-------|--------|
| #9574 | 90.0% | [Arc] Assertion failure when lowering inout ports in sequential logic | OPEN |
| #6810 | 10.0% | [Arc] Add basic assertion support | OPEN |
| #8825 | 10.0% | [LLHD] Switch from hw.inout to a custom signal reference type | OPEN |

### Recommendation

**Action**: Review Issue #9574 to confirm this is the same issue.

**Key Matches with #9574**:
- ✅ Error message: 100% match (identical)
- ✅ Tool/Dialect: 100% match (arcilator + arc)
- ✅ Pass: 100% match (LowerStatePass)
- ✅ Keywords: 75% match (6/8 keywords found)

---

## Files Generated

This analysis generated the following files:

- `metadata.json` - Reproduction metadata
- `reproduce.log` - Reproduction attempt log
- `root_cause.md` - Detailed root cause analysis
- `analysis.json` - Structured analysis data
- `duplicates.json` - Duplicate check results
- `duplicates.md` - Duplicate check report

---

## Conclusion

This analysis indicates:

1. **Likely Duplicate**: 90% similarity to Issue #9574
2. **May Be Fixed**: Could not reproduce on current toolchain (firtool-1.139.0 with LLVM 22.0.0git)
3. **Action Required**: Review Issue #9574 to confirm if this is the same bug

**Recommended Action**: No new issue should be created. Instead:
1. Review #9574 for confirmation
2. If confirmed to be the same, this case can be closed as a duplicate
3. If different, update #9574 with additional information from this analysis

---

*This analysis report was generated by the CIRCT Bug Reporter system.*
