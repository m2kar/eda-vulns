<!-- 
  CIRCT Bug Report
  Generated by automated bug reporter
  Date: 2026-01-31
-->

<!-- Title: [Moore] Assertion failure in ModulePortInfo::sanitizeInOut when using string type as module port -->

## Description

CIRCT crashes with an assertion failure when processing a SystemVerilog module that uses the `string` type as a port. The crash occurs during the MooreToCore lowering pass in `ModulePortInfo::sanitizeInOut()` when attempting to `dyn_cast` a null type.

**Root Cause**: The TypeConverter fails to convert the `string` type (a dynamic class type in SystemVerilog) to a valid HW type, returning null. The code path does not check for null after conversion, causing `dyn_cast` to fail on the null type.

**Crash Type**: Assertion failure - `detail::isPresent(Val) && "dyn_cast on a non-existent value"`
**Dialect**: Moore  
**Failing Pass**: MooreToCore

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv
   ```

## Test Case

```systemverilog
module test_module(input string str_in);
endmodule
```

## Error Output

```
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.	Program arguments: circt-verilog --ir-hw bug.sv
 #0 0x00007fb9cbe1d8a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x2008a8)
 #1 0x00007fb9cbe1b2f5 llvm::sys::RunSignalHandlers() (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x1fe2f5)
 #2 0x00007fb9cbe1e631 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0
 #3 0x00007fb9cb92b330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007fb9d003f8ae (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(...) MooreToCore.cpp:0:0
 #5 0x00007fb9d003fb93 llvm::LogicalResult mlir::ConversionPattern::dispatchTo1To1(...) 
...
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)
**Cause**: TypeConverter fails to convert `string` type to valid HW type, returning null.

**Evidence**:
- `string` is a dynamic SystemVerilog class type with no direct hardware representation
- Stack trace shows crash in `sanitizeInOut()` which operates on port types
- `dyn_cast` assertion explicitly checks for "non-existent value" (null)
- `getModulePortInfo()` (MooreToCore.cpp:243) uses `typeConverter.convertType()` result without null check

**Processing Path**:
1. `SVModuleOpConversion::matchAndRewrite()` called for `moore.module`
2. Calls `getModulePortInfo(typeConverter, op)`
3. `typeConverter.convertType(string_port_type)` returns null (no valid HW mapping)
4. Null type stored in `PortInfo`
5. `ModulePortInfo` constructor calls `sanitizeInOut()`
6. `dyn_cast<hw::InOutType>(nullType)` at PortImplementation.h:177 triggers assertion

### Hypothesis 2 (Medium Confidence)
**Cause**: Missing type conversion pattern for Moore string type.

**Evidence**:
- TypeConverter patterns may not explicitly handle `moore::StringType`
- String is a class-based type that may lack conversion rules

## Environment

- **CIRCT Version**: firtool-1.139.0
- **Tool**: circt-verilog
- **OS**: Linux x86_64
- **Test Case**: Valid IEEE 1800-2017 SystemVerilog (passes slang, verilator)

## Suggested Fixes

1. **Add null check in `getModulePortInfo()`** (MooreToCore.cpp:243)  
   Check if `typeConverter.convertType()` returns null and emit diagnostic error for unsupported port types.

2. **Add string type conversion pattern**  
   Either add explicit string type handling in TypeConverter or provide fallback mapping.

3. **Defensive guard in `sanitizeInOut()`** (PortImplementation.h:177)  
   Add `if (!p.type) continue;` before dyn_cast operations.

## Stack Trace

<details>
<summary>Click to expand full stack trace</summary>

```
#0 0x00007fb9cbe1d8a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
#1 0x00007fb9cbe1b2f5 llvm::sys::RunSignalHandlers()
#2 0x00007fb9cbe1e631 SignalHandler(int, siginfo_t*, void*)
#3 0x00007fb9cb92b330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
#4 0x00007fb9d003f8ae (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const MooreToCore.cpp:0:0
#5 0x00007fb9d003fb93 llvm::LogicalResult mlir::ConversionPattern::dispatchTo1To1<mlir::OpConversionPattern<circt::moore::SVModuleOp>, circt::moore::SVModuleOp>(mlir::OpConversionPattern<circt::moore::SVModuleOp> const&, circt::moore::SVModuleOp, circt::moore::SVModuleOp::GenericAdaptor<llvm::ArrayRef<mlir::ValueRange>>, mlir::ConversionPatternRewriter&)
#6 0x00007fb9d003f530 mlir::OpConversionPattern<circt::moore::SVModuleOp>::matchAndRewrite(mlir::Operation*, llvm::ArrayRef<mlir::ValueRange>, mlir::ConversionPatternRewriter&) const
#7 0x00007fb9ce351438 mlir::ConversionPattern::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&) const
#8 0x00007fb9ce31b8ed void llvm::function_ref<void ()>::callback_fn<mlir::PatternApplicator::matchAndRewrite(...)::$_0>(long)
#9 0x00007fb9ce318774 mlir::PatternApplicator::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&, ...)
#10 0x00007fb9ce352c6f (anonymous namespace)::OperationLegalizer::legalize(mlir::Operation*)
#11 0x00007fb9ce352470 mlir::OperationConverter::convert(mlir::Operation*, bool)
#12 0x00007fb9ce352dae mlir::OperationConverter::convertOperations(llvm::ArrayRef<mlir::Operation*>)
#13 0x00007fb9ce3608e4 void llvm::function_ref<void ()>::callback_fn<applyConversion(...)::$_0>(long)
#14 0x00007fb9ce357f7d applyConversion(llvm::ArrayRef<mlir::Operation*>, mlir::ConversionTarget const&, ...)
#15 0x00007fb9ce3580fe mlir::applyFullConversion(mlir::Operation*, mlir::ConversionTarget const&, ...)
#16 0x00007fb9d0011231 (anonymous namespace)::MooreToCorePass::runOnOperation() MooreToCore.cpp:0:0
#17 0x00007fb9ce10d2a5 mlir::detail::OpToOpPassAdaptor::run(mlir::Pass*, mlir::Operation*, mlir::AnalysisManager, bool, unsigned int)
#18 0x00007fb9ce1107a9 mlir::PassManager::run(mlir::Operation*)
#19 0x000055bcf26d35d0 executeWithSources(mlir::MLIRContext*, llvm::SourceMgr&)
#20 0x000055bcf26cedd5 execute(mlir::MLIRContext*)
#21 0x000055bcf26ce4b8 main
#22 0x00007fb9cb9101ca __libc_start_call_main
#23 0x00007fb9cb91028b call_init
#24 0x00007fb9cb91028b __libc_start_main
#25 0x000055bcf26cdb05 _start
```

</details>

## Validation Results

- **Syntax Check**: ✓ Valid (slang 10.0.6)
- **Feature Support**: ✓ Supported IEEE 1800-2017
- **Cross-Tool Validation**: 
  - slang: ✓ pass
  - verilator: ✓ pass
  - icarus: ✗ error (tool limitation)
- **Test Case Minimization**: 91.3% reduction (23 → 2 lines)

## Duplicates Review

⚠️ **IMPORTANT**: Please review before posting to GitHub

**Top Related Issue**: 
- **#8332**: "[MooreToCore] Support for StringType from moore to llvm dialect"
  - Similarity Score: 16/100 (high relevance)
  - **Recommendation**: Review issue #8332 to determine if this is a duplicate or related follow-up

**Search Context**:
- Total issues found: 43 matching "Moore + MooreToCore + assertion"
- This test case specifically addresses string type conversion failure
- May be a known limitation or existing enhancement request

---

*This issue was generated with assistance from an automated bug reporter.*
*Generated: 2026-01-31*
