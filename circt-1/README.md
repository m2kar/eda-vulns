# CIRCT Vulnerability Report - Array Indexing in Sensitivity Lists

**Vulnerability ID:** CVE-PENDING  
**CVSS Score:** 5.3 (Medium)  
**Discovery Date:** 2026-01-18  
**Discoverer:** M2kar (@m2kar)  
**GitHub Issue:** https://github.com/llvm/circt/issues/9469  
**Fix PR:** https://github.com/llvm/circt/pull/9481

> [‰∏≠ÊñáÁâàÊú¨ / Chinese Version](README.zh.md)

---

## Table of Contents

- [1. Vulnerability Overview](#1-vulnerability-overview)
- [2. Technical Details](#2-technical-details)
- [3. Reproduction](#3-reproduction)
- [4. Impact Analysis](#4-impact-analysis)
- [5. Remediation](#5-remediation)
- [6. CVE Classification](#6-cve-classification)
- [7. References](#7-references)

---

## 1. Vulnerability Overview

### 1.1 Description

An inconsistency has been identified in CIRCT's handling of direct array indexing (e.g., `clkin_data[0]`) in SystemVerilog `always_ff` sensitivity lists. The compiler fails with an illegal `llhd.constant_time` operation error, but semantically equivalent code using intermediate wire assignments compiles successfully.

### 1.2 Affected Scope

- **Affected Versions:** CIRCT firtool-1.139.0 and earlier
- **Affected Components:** circt-verilog, arcilator, LLHD lowering pipeline
- **Affected Scenarios:**
  - ‚ùå Direct array indexing as clock/reset signals
  - ‚ùå Code generated by automated hardware tools (e.g., Yosys)
  - ‚ùå Indexed clock selection in multi-clock domain designs
  - ‚úÖ Equivalent code using intermediate wires works

---

## 2. Technical Details

### 2.1 Root Cause

The LLHD lowering pipeline's `Mem2Reg` and `HoistSignals` passes fail to recognize array element accesses (`clkin_data[0]`) as valid clock signals, leading to:

1. Frontend fails to properly identify it as a clock signal
2. Lowering process cannot convert to `seq.firreg` operations
3. Generates illegal `llhd.constant_time` operations
4. Arcilator backend rejects compilation

### 2.2 Error Signature

```
error: failed to legalize operation 'llhd.constant_time' that was explicitly marked illegal
    %0 = llhd.constant_time <0ns, 1d, 0e>
         ^
<stdin>:1:1: error: conversion to arcs failed
```

### 2.3 Vulnerable Code Example

**Vulnerable Code (top1.sv) - ‚ùå Compilation Fails:**
```systemverilog
module top_arc(clkin_data, in_data, out_data);
  reg [5:0] _00_;
  input [63:0] clkin_data;
  input [191:0] in_data;
  output [191:0] out_data;

  // Direct array indexing - Compilation fails
  always_ff @(posedge clkin_data[0])
    if (!clkin_data[32]) _00_ <= 6'h00;
    else _00_ <= in_data[7:2];
endmodule
```

**Workaround Code (top2.sv) - ‚úÖ Compilation Succeeds:**
```systemverilog
module top_arc(clkin_data, in_data, out_data);
  reg [5:0] _00_;
  input [63:0] clkin_data;
  input [191:0] in_data;
  output [191:0] out_data;

  // Intermediate wire assignment - Compilation succeeds
  wire clkin_0 = clkin_data[0];
  wire rst = clkin_data[32];
  
  always_ff @(posedge clkin_0)
    if (!rst) _00_ <= 6'h00;
    else _00_ <= in_data[7:2];
endmodule
```

---

## 3. Reproduction

### 3.1 Project Structure

```
circt-1/
‚îú‚îÄ‚îÄ Dockerfile                  # Docker vulnerability reproduction environment
‚îú‚îÄ‚îÄ test.sh                    # Quick test script
‚îú‚îÄ‚îÄ reproduce.sh               # Automated reproduction script
‚îú‚îÄ‚îÄ top1.sv                    # Vulnerable code (780B)
‚îú‚îÄ‚îÄ top2.sv                    # Workaround code (764B)
‚îî‚îÄ‚îÄ results/                   # Test output directory
    ‚îú‚îÄ‚îÄ top1.err               # Vulnerable code error output
    ‚îú‚îÄ‚îÄ top1_detailed_ir.mlir  # Vulnerable code IR analysis (66KB)
    ‚îú‚îÄ‚îÄ top2.json              # Successful compilation state file (471B)
    ‚îú‚îÄ‚îÄ top2_detailed_ir.mlir  # Workaround code IR analysis (56KB)
    ‚îî‚îÄ‚îÄ top2.out               # Successful compilation output
```

### 3.2 Quick Start

#### Method 1: Using Quick Script

```bash
# 1. Build image (first run)
./test.sh build

# 2. Run full test
./test.sh run

# 3. Save output files
./test.sh save

# 4. View other options
./test.sh help
```

#### Method 2: Using Docker Commands

```bash
# Pull image from GitHub Container Registry
docker pull ghcr.io/m2kar/eda-vulns/circt-1:latest

# Run test
docker run --platform linux/amd64 --rm ghcr.io/m2kar/eda-vulns/circt-1:latest

# Save output
docker run --platform linux/amd64 --rm \
  -v $(pwd)/results:/vuln-reproduction/output \
  ghcr.io/m2kar/eda-vulns/circt-1:latest
```

#### Method 3: Manual Testing

```bash
# Enter container
docker run --platform linux/amd64 --rm -it \
  --entrypoint /bin/bash ghcr.io/m2kar/eda-vulns/circt-1:latest

# Run manually inside container
circt-verilog --ir-hw top1.sv | arcilator --state-file=top1.json  # Fails
circt-verilog --ir-hw top2.sv | arcilator --state-file=top2.json  # Succeeds
```

### 3.3 Test Results

**Test Platform:** macOS (Apple M3 Pro) + Docker (linux/amd64)  
**Test Date:** 2026-01-21  
**CIRCT Version:** firtool-1.139.0

| Test | Expected | Actual | Status |
|------|----------|--------|--------|
| Vulnerable code (top1.sv) | Compilation fails | Compilation failed ‚ùå | ‚úÖ PASS |
| Workaround code (top2.sv) | Compilation succeeds | Compilation succeeded ‚úÖ | ‚úÖ PASS |
| Error signature detection | llhd.constant_time | Detected | ‚úÖ PASS |

**Conclusion:** ‚úÖ **Vulnerability Successfully Reproduced**

---

## 4. Impact Analysis

### 4.1 Functional Impact

| Category | Level | Description |
|----------|-------|-------------|
| Design Correctness | üü° MEDIUM | Requires code refactoring but simple workaround available |
| Tool Interoperability | üü° MEDIUM | Affects automated synthesis tool compatibility |
| Development Workflow | üü° MEDIUM | Requires manual intervention but solution is straightforward |
| Verification Coverage | üü¢ LOW | Workaround produces semantically equivalent behavior |

### 4.2 Security Implications

1. **Code Integrity Risk**
   - Manual code restructuring increases risk of human error
   - Forced modifications to verified designs may introduce functional bugs
   - Divergence between original and modified code complicates auditing

2. **Supply Chain Vulnerability**
   - Automated hardware generation pipelines may produce standard-compliant code that fails compilation
   - Requires manual intervention, breaking automated workflows
   - Affects reproducibility of hardware builds

3. **Compiler Trust**
   - Inconsistent handling of semantically equivalent code undermines compiler reliability
   - May mask or indicate presence of other undiscovered compilation issues
   - Reduces confidence in compiler's ability to correctly translate HDL specifications

### 4.3 Affected Use Cases

- **FPGA Development:** Direct array indexing for clock/reset multiplexing
- **ASIC Design:** Indexed clock selection in multi-clock domain designs
- **Hardware Fuzzing:** Automated test case generation (e.g., Yosys)
- **Legacy IP Migration:** Existing designs using standard SystemVerilog patterns

---

## 5. Remediation

### 5.1 Immediate Workaround

```systemverilog
// ‚ùå Code that fails
always_ff @(posedge clkin_data[0])
  if (!clkin_data[32]) begin
    // logic
  end

// ‚úÖ Workaround code
wire clk = clkin_data[0];
wire rst = clkin_data[32];
always_ff @(posedge clk)
  if (!rst) begin
    // logic
  end
```

### 5.2 Long-term Solution

Upgrade to CIRCT version containing PR #9481 fix:

```bash
git clone https://github.com/llvm/circt.git
cd circt
git checkout main  # Ensure PR #9481 is included
# Build according to official documentation
```

### 5.3 Detection Methods

**Grep pattern to detect vulnerable code:**
```bash
# Search for array indexing in sensitivity lists
grep -rn "@(posedge.*\[.*\]" *.sv
grep -rn "@(negedge.*\[.*\]" *.sv
```

**AST-based detection:**
```bash
# Use circt-verilog to check if code triggers vulnerability
circt-verilog --ir-hw suspicious.sv 2>&1 | \
  grep -q "llhd.constant_time" && echo "VULNERABLE"
```

---

## 6. CVE Classification

### 6.1 CVSS v3.1 Scoring

**Vector String:**  
`CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:L`

**Base Score:** 5.3 (MEDIUM)

| Metric | Value | Rationale |
|--------|-------|-----------|
| Attack Vector (AV) | Local | Requires local access to compilation environment |
| Attack Complexity (AC) | Low | Standard SystemVerilog code can trigger |
| Privileges Required (PR) | None | Any compilation user can trigger |
| User Interaction (UI) | Required | User must attempt compilation |
| Scope (S) | Unchanged | Impact limited to compilation pipeline |
| Confidentiality (C) | None | No information disclosure |
| Integrity (I) | Low | Requires code modification but workaround available |
| Availability (A) | Low | Temporary disruption but solution straightforward |

### 6.2 CWE Classification

- **CWE-703:** Improper Check or Handling of Exceptional Conditions
- **CWE-697:** Incorrect Comparison (compiler fails to recognize equivalent signal representations)
- **CWE-1304:** Improperly Preserved Integrity of Hardware Configuration State

### 6.3 Risk Assessment

**Risk Level:** üü° MEDIUM (CVSS 5.3)

**Recommended Priority:** MEDIUM - Should deploy fix in next maintenance cycle

**Rationale:**
- Compiler inconsistency affects code integrity and automated workflows
- Requires manual intervention that may introduce errors
- Impact limited to development phase with clear error messages (not silent failures)
- Well-documented workaround available, though it adds maintenance burden
- No confidentiality breach or privilege escalation

---

## 7. References

### 7.1 GitHub Resources

- **Issue:** https://github.com/llvm/circt/issues/9469
- **Fix PR:** https://github.com/llvm/circt/pull/9481
- **Related Issue:** https://github.com/llvm/circt/issues/9467

### 7.2 Official Documentation

- **CIRCT:** https://circt.llvm.org/
- **LLHD Dialect:** https://circt.llvm.org/docs/Dialects/LLHD/
- **Arcilator:** https://circt.llvm.org/docs/Dialects/Arc/RationaleArc/

### 7.3 Timeline

| Date | Event |
|------|-------|
| 2026-01-18 | Vulnerability discovered and reported by M2kar (Issue #9469) |
| 2026-01-20 14:46 UTC | @5iri confirmed as valid bug |
| 2026-01-20 15:05 UTC | @5iri identified root cause in WaitEventOpConversion |
| 2026-01-20 17:05 UTC | @fabianschuiki confirmed dual issue: LLHD lowering and Arcilator support |
| 2026-01-20 17:30 UTC | @5iri assigned to implement fix |
| 2026-01-21 | Pull Request #9481 submitted |
| 2026-01-21 14:08 UTC | M2kar confirmed fix resolves issue |

### 7.4 Contributors

- **Reporter:** M2kar (@m2kar)
- **Analysis:** 5iri (@5iri)
- **Maintainer:** Fabian Schuiki (@fabianschuiki)
- **Fix Implementation:** 5iri (@5iri)

---

## 8. Appendix

### 8.1 Test Environment

- **Operating System:** Ubuntu 24.04 (x86_64) in Docker
- **Platform:** macOS (Apple M3 Pro) with linux/amd64 emulation
- **CIRCT Version:** firtool-1.139.0
- **LLVM Version:** 22.0.0git

### 8.2 Generated Files

```
results/
‚îú‚îÄ‚îÄ top1.err                  342 bytes   Vulnerable code error output
‚îú‚îÄ‚îÄ top1_detailed_ir.mlir     66 KB      Vulnerable code detailed IR
‚îú‚îÄ‚îÄ top2.json                 471 bytes  ‚úÖ Successful state file
‚îú‚îÄ‚îÄ top2_detailed_ir.mlir     56 KB      Workaround code detailed IR
‚îî‚îÄ‚îÄ top2.out                  1.1 KB     Successful compilation output
```

### 8.3 Disclosure Policy

This report follows coordinated disclosure practices:

1. ‚úÖ Used public issue tracker (GitHub Issues) - vendor's preferred channel
2. ‚úÖ Maintainers engaged, fix in progress (PR #9481)
3. ‚úÖ No active exploitation observed (compiler toolchain bug)
4. ‚úÖ Workaround available (intermediate wire assignment)
5. ‚è≥ Awaiting CVE assignment and official vendor advisory

**Status:** Public disclosure with active fix development

---

## 9. Contact

**Reporter:** M2kar  
**GitHub:** [@m2kar](https://github.com/m2kar)  
**Email:** zhiqing.rui@gmail.com  
**Issue Tracker:** https://github.com/llvm/circt/issues/9469

---

**Document Version:** 2.0  
**Last Updated:** 2026-01-22  
**Status:** Ready for CVE Submission  
**License:** MIT
