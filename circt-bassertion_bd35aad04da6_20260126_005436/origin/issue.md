<!-- 
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Moore] Crash in MooreToCore when module has string type port -->

## Description

circt-verilog crashes when processing a SystemVerilog module with a `string` type port. The crash occurs in the MooreToCore pass because the TypeConverter lacks a conversion handler for `moore::StringType`, causing `convertType()` to return null. This null type is then passed to `hw::PortInfo`, and a subsequent `dyn_cast` on the null value triggers an assertion failure.

Even if `string` ports are not yet fully supported, CIRCT should emit a proper diagnostic error instead of crashing.

**Crash Type**: Assertion failure  
**Dialect**: Moore  
**Failing Pass**: MooreToCore (convert-moore-to-core)

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv
   ```

## Test Case

```systemverilog
module t(output string s);
endmodule
```

## Error Output

```
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.	Program arguments: circt-verilog --ir-hw bug.sv
 #0 0x00007f1843e238a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
 #4 0x00007f18480458ae SVModuleOpConversion::matchAndRewrite(...) MooreToCore.cpp:0:0
...
```

The full assertion message (from debug build):
```
Assertion `detail::isPresent(Val) && "dyn_cast on a non-existent value"' failed.
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)

**Cause**: MooreToCore TypeConverter lacks a conversion handler for `moore::StringType`

**Evidence**:
- `populateTypeConversion()` function has converters for `IntType`, `RealType`, `FormatStringType`, `ArrayType`, `StructType`, etc., but **no `StringType` converter**
- The error message explicitly indicates `dyn_cast on a non-existent value` (null type)
- The only unusual construct in the test case is the `string` type port
- `FormatStringType` has a converter, but `StringType` does not

**Mechanism**: 
1. SystemVerilog `string` type is parsed into `moore::StringType`
2. MooreToCore pass calls `getModulePortInfo()` to convert module ports
3. `typeConverter.convertType(port.type)` returns null for `StringType` (no converter registered)
4. Null type is stored in `hw::PortInfo` without validation
5. Later code attempts `dyn_cast<hw::InOutType>` on null → assertion failure

### Code Path

```
getModulePortInfo() [MooreToCore.cpp:234-259]
  └─ typeConverter.convertType(port.type)  // returns null for StringType
     └─ hw::PortInfo{{port.name, portTy /*null*/, port.dir}, ...}
        └─ dyn_cast<hw::InOutType>(portTy)  // CRASH: null value
```

## Suggested Fix

**Option A**: Add `StringType` conversion handler
```cpp
// In populateTypeConversion():
typeConverter.addConversion([&](StringType type) -> std::optional<Type> {
  // Option 1: Convert to an appropriate LLVM type representation
  // Option 2: Return {} to indicate unsupported, with proper error handling upstream
  return {};
});
```

**Option B**: Add null check in `getModulePortInfo()`
```cpp
Type portTy = typeConverter.convertType(port.type);
if (!portTy) {
  op.emitError() << "unsupported port type: " << port.type;
  return failure();
}
```

## Environment

- **CIRCT Version**: firtool-1.139.0
- **LLVM Version**: 22.0.0git
- **Slang Version**: 9.1.0
- **OS**: Linux
- **Architecture**: x86_64

## Cross-Tool Validation

| Tool | Status | Notes |
|------|--------|-------|
| slang | ✅ pass | Syntax valid |
| verilator | ✅ pass | Lint passes |
| icarus | ⚠️ unsupported | "Port with type `string` is not supported" |

The test case uses **valid SystemVerilog syntax** according to IEEE 1800-2017. Both slang and verilator accept this code.

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
 #0 0x00007f1843e238a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x2008a8)
 #1 0x00007f1843e212f5 llvm::sys::RunSignalHandlers() (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x1fe2f5)
 #2 0x00007f1843e24631 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0
 #3 0x00007f1843931330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007f18480458ae (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const MooreToCore.cpp:0:0
 #5 0x00007f1848045b93 llvm::LogicalResult mlir::ConversionPattern::dispatchTo1To1<mlir::OpConversionPattern<circt::moore::SVModuleOp>, circt::moore::SVModuleOp>(...)
 #6 0x00007f1848045530 mlir::OpConversionPattern<circt::moore::SVModuleOp>::matchAndRewrite(...)
 #7 0x00007f1846357438 mlir::ConversionPattern::matchAndRewrite(...)
 #8 0x00007f18463218ed void llvm::function_ref<void ()>::callback_fn<mlir::PatternApplicator::matchAndRewrite(...)::$_0>(long)
 #9 0x00007f184631e774 mlir::PatternApplicator::matchAndRewrite(...)
#10 0x00007f1846358c6f (anonymous namespace)::OperationLegalizer::legalize(mlir::Operation*)
#11 0x00007f1846358470 mlir::OperationConverter::convert(mlir::Operation*, bool)
#12 0x00007f1846358dae mlir::OperationConverter::convertOperations(llvm::ArrayRef<mlir::Operation*>)
#16 0x00007f1848017231 (anonymous namespace)::MooreToCorePass::runOnOperation()
#17 0x00007f18461132a5 mlir::detail::OpToOpPassAdaptor::run(...)
#18 0x00007f18461167a9 mlir::PassManager::run(mlir::Operation*)
#19 0x000055f5ebb385d0 executeWithSources(mlir::MLIRContext*, llvm::SourceMgr&) circt-verilog.cpp
#20 0x000055f5ebb33dd5 execute(mlir::MLIRContext*) circt-verilog.cpp
#21 0x000055f5ebb334b8 main
```

</details>

## Related Issues

- **#8332**: [MooreToCore] Support for StringType from moore to llvm dialect (**Similarity: 8.5** ⚠️)
  - This issue directly discusses adding StringType support. Our crash is a manifestation of this missing support.
  - While #8332 discusses general StringType lowering, this report provides a minimal reproducer and crash details for the specific case of `string` as a module port.
- #8930: [MooreToCore] Crash with sqrt/floor (same assertion symptom, different root cause)

---
*This issue was generated with assistance from an automated bug reporter.*
