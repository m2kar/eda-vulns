<!-- 
  CIRCT Bug Report: Arc StateType Assertion Failure with inout Ports
  Generated by automated bug reporter
  Test Case ID: 260128-00000ff4
-->

## Description

The Arcilator tool crashes when processing a SystemVerilog module containing an `inout wire` port. The `inout` port is lowered to a `!llhd.ref<i1>` type (LLHD reference type) by the front-end, but Arc dialect's `StateType` verification fails because it does not support LLHD reference types. The verification function `computeLLVMBitWidth()` returns `std::nullopt` for `llhd::RefType`, causing an assertion failure in MLIR's type uniquer.

**Original Crash Context** (CIRCT 1.139.0):
- **Tool Chain**: `circt-verilog --ir-hw | arcilator`
- **Dialect**: Arc
- **Failing Pass**: `LowerStatePass` (arc-lower-state)
- **Crash Type**: Assertion failure in MLIR type verification

**Related Issue**: This bug is highly related to [#8825](https://github.com/llvm/circt/issues/8825) "Switch from hw.inout to a custom signal reference type" (90% similarity) which discusses the underlying LLHD reference type design.

---

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run the following command:
   ```bash
   circt-verilog --ir-hw test.sv | arcilator
   ```

---

## Test Case

```systemverilog
module InoutBug(
  inout wire c
);
endmodule
```

**Note**: This is the minimal test case that triggers the crash. The `inout` keyword is the problematic construct.

---

## Actual Behavior

**Original Error Output** (CIRCT 1.139.0):
```
<unknown>:0: error: state type must have a known bit width; got '!llhd.ref<i1>'
arcilator: /path/to/mlir/include/mlir/IR/StorageUniquerSupport.h:180: 
Assertion `succeeded(ConcreteT::verifyInvariants(getDefaultDiagnosticEmitFn(ctx), args...))' failed.
```

**LLVM IR Output Generated Before Crash**:
```llvm
; ModuleID = 'LLVMDialectModule'
source_filename = "LLVMDialectModule"

declare void @exit(i32)

define void @InoutBug_eval(ptr %0) {
  ret void
}

!llvm.module.flags = !{!0}

!0 = !{i32 2, !"Debug Info Version", i32 3}
```

The LLVM IR generation succeeds, but Arcilator's lowering pipeline fails during the `LowerStatePass`.

---

## Expected Behavior

Arcilator should either:
1. **Properly handle** `inout` ports by converting `!llhd.ref<T>` types to a supported representation, or
2. **Reject gracefully** with a clear diagnostic message explaining that `inout` ports are not supported in Arcilator

Instead, the tool crashes with an assertion failure, providing no actionable error message.

---

## Root Cause Analysis

### Crash Location
- **File**: `lib/Dialect/Arc/ArcTypes.cpp`
- **Function**: `StateType::verify()`
- **Line**: ~80-85
- **Call Site**: `lib/Dialect/Arc/Transforms/LowerState.cpp:219`

### Root Cause Mechanism

**High Confidence**: Arc dialect's `StateType` cannot handle LLHD reference types (`!llhd.ref<T>`).

The failure occurs during module input lowering:

1. **Front-end Lowering**: `circt-verilog --ir-hw` parses SystemVerilog and produces HW dialect IR
   - `inout wire c` is converted to a module argument with type `!llhd.ref<i1>`

2. **LowerStatePass Execution**: Arcilator's `LowerStatePass` processes the HW module
   - At `LowerState.cpp:219`, the pass iterates over module arguments to allocate storage
   - For each argument, it calls `StateType::get(arg.getType())`

3. **Type Verification Failure**: `StateType::verify()` is invoked by MLIR's type uniquer
   - Calls `computeLLVMBitWidth(innerType)` to validate the type
   - Returns `std::nullopt` for `!llhd.ref<i1>` (no handler for LLHD ref types)
   - Verification fails with error: "state type must have a known bit width"

4. **Assertion Failure**: The failed verification triggers an assertion in `StorageUniquerSupport.h:180`

### Code Evidence

**File: lib/Dialect/Arc/ArcTypes.cpp**
```cpp
LogicalResult
StateType::verify(llvm::function_ref<InFlightDiagnostic()> emitError,
                  Type innerType) {
  if (!computeLLVMBitWidth(innerType))  // Returns nullopt for !llhd.ref<T>
    return emitError() << "state type must have a known bit width; got "
                       << innerType;
  return success();
}
```

The `computeLLVMBitWidth()` function only handles:
- `seq::ClockType` → 1 bit
- `IntegerType` → width bits  
- `hw::ArrayType` → recursive computation
- `hw::StructType` → recursive computation
- **All other types (including `llhd::RefType`)** → `std::nullopt`

**File: lib/Dialect/Arc/Transforms/LowerState.cpp** (line ~219)
```cpp
for (auto arg : moduleOp.getBodyBlock()->getArguments()) {
  auto name = moduleOp.getArgName(arg.getArgNumber());
  auto state = RootInputOp::create(allocBuilder, arg.getLoc(),
                  StateType::get(arg.getType()),  // <-- CRASH HERE
                  name, storageArg);
}
```

---

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
Frame #0: Assertion failure triggered in StorageUniquerSupport.h:180

Frame #11 0x0000562d0cb68bbc
  (StateType::get verification fails)

Frame #12 0x0000562d0cb68ae9 circt::arc::StateType::get(mlir::Type)
  ArcTypes.cpp.inc:108

Frame #13 0x0000562d0cbd3f5c ModuleLowering::run()
  LowerState.cpp:219

Frame #14 0x0000562d0cbd3f5c LowerStatePass::runOnOperation()
  LowerState.cpp:1198
```

The crash occurs during the construction of `StateType` when processing module inputs. The MLIR type system's verification hook detects that the state type is invalid and triggers an assertion.

</details>

---

## Environment

| Item | Value |
|------|-------|
| **Original CIRCT Version** | firtool-1.139.0 |
| **Original LLVM Version** | LLVM built from source (pre-LLVM 22) |
| **Current CIRCT Version** | firtool-1.139.0 |
| **Current LLVM Version** | LLVM 22.0.0git |
| **Test Case Language** | SystemVerilog (IEEE 1800-2017) |
| **OS** | Linux |
| **Reproduction Status** | Does NOT reproduce in current toolchain (appears fixed) |

---

## Related Issues

### High Similarity Match

- **[#8825](https://github.com/llvm/circt/issues/8825)**: "[LLHD] Switch from hw.inout to a custom signal reference type"
  - **Similarity Score**: 90/100
  - **Relationship**: The underlying root cause relates to LLHD's reference type design for modeling bidirectional signals. Issue #8825 discusses broader changes to the signal reference type system that may address this crash.
  - **Status**: Open
  - **Relevance**: Fixing #8825 or related LLHD/Arc integration may resolve this assertion failure

### Related Arc Issues

- **[#4916](https://github.com/llvm/circt/issues/4916)**: "[Arc] LowerState: nested arc.state get pulled in wrong clock tree"
  - Similar Arc dialect issues in the LowerState pass, though with different root cause

---

## Suggested Fix Directions

Based on the root cause analysis, there are three potential fix approaches:

1. **Early Validation** (Recommended for immediate fix)
   - Add a pre-check in `LowerStatePass` or Arcilator's pipeline to detect and reject modules with `!llhd.ref` typed ports
   - Provide a clear diagnostic explaining that `inout` ports are not supported in Arcilator
   - Prevents the assertion failure and provides actionable error message

2. **Extend `computeLLVMBitWidth()`** (If LLHD refs should be supported)
   - Add a case handler for `llhd::RefType` in `computeLLVMBitWidth()`
   - Extract the inner type's bit width (e.g., for `!llhd.ref<i1>`, return 1)
   - This would allow StateType to accept LLHD reference types

3. **Add LLHD-to-supported Type Lowering Pass** (More comprehensive)
   - Add a pre-lowering pass before `LowerStatePass` that converts LLHD ref types to Arc-supported representations
   - Example: split `inout` ports into separate input/output ports with resolved wire types
   - Aligns with Issue #8825's longer-term goals for signal reference type redesign

---

## Keywords

`arcilator` `StateType` `llhd.ref` `inout` `bit width` `LowerState` `computeLLVMBitWidth` `bidirectional` `tristate` `Arc` `assertion failure` `MLIR` `type verification`

---

## Validation Summary

- ✅ **Test Case Validity**: Valid SystemVerilog (IEEE 1800-2017 compliant)
- ✅ **Syntax Check**: Valid with slang compiler (0 errors, 0 warnings)
- ✅ **Cross-Tool Validation**: Passes Verilator, Icarus, and Slang
- ✅ **Root Cause Identified**: Clear mechanism in Arc/LLHD type system
- ⚠️ **Reproduction Status**: Does NOT reproduce in current toolchain (appears fixed)

---

## Historical Notes

This bug was discovered during fuzzing of CIRCT 1.139.0 and documents a real issue in the Arc dialect's handling of LLHD reference types. Although it does not reproduce in the current build (LLVM 22.0.0git), it:

1. Provides a minimal test case for regression prevention
2. Documents a type system compatibility issue between Arc and LLHD dialects
3. Is highly related to Issue #8825 which addresses broader LLHD signal reference type design
4. May be useful for understanding Arc's limitations with bidirectional signals

---

*This issue was generated with assistance from an automated bug reporter and is being submitted to track a historical CIRCT bug.*
