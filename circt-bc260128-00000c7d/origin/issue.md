# [MooreToCore] Assertion failure when module has string output port

## Summary

`circt-verilog` crashes with assertion failure `dyn_cast on a non-existent value` when compiling a SystemVerilog module that has a `string` type output port. The crash occurs in the MooreToCore conversion pass when `sanitizeInOut()` attempts to process the converted port type.

## Reproduction

### Minimal Test Case

```systemverilog
module test_module(
  input logic clk,
  output string result
);
endmodule
```

### Command

```bash
circt-verilog --ir-hw bug.sv
```

### Environment

- **CIRCT Version**: firtool-1.139.0
- **LLVM Version**: 22.0.0git
- **Platform**: Linux x86_64

## Error Output

```
circt-verilog: .../llvm/Support/Casting.h:650: 
decltype(auto) llvm::dyn_cast(From &) [To = circt::hw::InOutType, From = mlir::Type]: 
Assertion `detail::isPresent(Val) && "dyn_cast on a non-existent value"' failed.

PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.  Program arguments: circt-verilog --ir-hw bug.sv
 #4 (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(...) MooreToCore.cpp:0:0
 ...
#16 (anonymous namespace)::MooreToCorePass::runOnOperation() MooreToCore.cpp:0:0
```

### Key Stack Frames

| Frame | Function | Location |
|-------|----------|----------|
| #4 | `SVModuleOpConversion::matchAndRewrite` | MooreToCore.cpp |
| #16 | `MooreToCorePass::runOnOperation` | MooreToCore.cpp |

## Root Cause Analysis

### Crash Mechanism

1. **Input**: Module with `output string result` port
2. **Moore Parser**: Creates `moore::StringType` for the string type
3. **Type Conversion**: `getModulePortInfo()` calls `typeConverter.convertType(port.type)`
4. **StringType Handling**: The type converter converts `moore::StringType` to `sim::DynamicStringType` (line 2277-2278 in MooreToCore.cpp)
5. **ModulePortInfo Construction**: Creates `hw::ModulePortInfo` with the converted types
6. **sanitizeInOut()**: Iterates through all ports and executes `dyn_cast<hw::InOutType>(p.type)`
7. **Crash**: `sim::DynamicStringType` is not `hw::InOutType`, causing the dyn_cast assertion to fail

### Root Cause

The MooreToCore type converter does not provide a proper conversion path for `string` types when used as module port types. The current implementation converts `moore::StringType` to `sim::DynamicStringType`, which is a Sim dialect type rather than an HW dialect type. When `ModulePortInfo::sanitizeInOut()` processes the ports, it encounters this non-HW type and the `dyn_cast<hw::InOutType>` fails because the type storage is not properly initialized for this cast operation.

### Affected Code Locations

| File | Line | Function | Issue |
|------|------|----------|-------|
| `MooreToCore.cpp` | 2277-2278 | `populateMooreToCoreTypeConverter` | StringType â†’ DynamicStringType conversion |
| `MooreToCore.cpp` | 234-259 | `getModulePortInfo` | Uses converted type without validation |
| `PortImplementation.h` | 175-181 | `sanitizeInOut` | Assumes all port types are HW types |

## Classification

- **Type**: Compiler Bug
- **Severity**: High (causes crash on valid SystemVerilog)
- **Category**: Type Conversion
- **Affected Component**: MooreToCore pass, specifically `SVModuleOpConversion`

## Suggested Fix Directions

1. **Option 1 (Recommended)**: Add explicit handling for `StringType` in `getModulePortInfo()` to emit a clear error message that string ports are not supported for hardware synthesis
2. **Option 2**: Modify `sanitizeInOut()` to skip non-HW dialect types gracefully
3. **Option 3**: Add a type conversion rule that properly handles or rejects `StringType` for module ports before reaching `ModulePortInfo` construction

## Related Issues

| Issue | Title | Similarity | Notes |
|-------|-------|------------|-------|
| #8332 | [MooreToCore] Support for StringType from moore to llvm dialect | High | Same dialect, same pass, related to string type handling |
| #8283 | [ImportVerilog] Cannot compile forward declared string type | Medium | Related string type compilation issue |
| #8382 | [FIRRTL] Crash with fstring type on port | Low | Similar pattern (type on port causing crash) |

## Additional Context

- The test case is valid SystemVerilog syntax (verified with slang)
- The `string` type is a dynamic type in SystemVerilog, commonly used for testbench code
- This bug likely affects any attempt to use string-typed ports in modules compiled through `circt-verilog`

---

*Generated by CIRCT Bug Report Workflow*
*Crash ID: circt-bc260128-00000c7d*
*Date: 2026-02-01*
