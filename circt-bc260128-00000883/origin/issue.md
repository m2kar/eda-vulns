<!--
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->
<!-- Title: [Moore] Assertion failure in MooreToCore when lowering packed union port type -->

## Description

CIRCT's Moore dialect crashes with an assertion failure when processing a SystemVerilog module that has a **packed union** type as a module port. The crash occurs during MooreToCore conversion pass when `typeConverter.convertType()` returns a null/invalid type for the packed union port, and `sanitizeInOut()` attempts to `dyn_cast<hw::InOutType>` on that null type.

**Crash Type**: Assertion Failure
**Dialect**: Moore → HW (MooreToCore pass)
**Failing Pass**: MooreToCore

The root cause is a missing null type check in `getModulePortInfo()`. When `typeConverter.convertType(port.type)` fails for a packed union type (returning a null `Type`), the code does not validate the result before creating `hw::PortInfo`. Later, when `ModulePortInfo`'s constructor calls `sanitizeInOut()`, the `dyn_cast` operation fails with an assertion because it cannot operate on a null/empty `Type`.

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv
   ```

## Test Case

```systemverilog
typedef union packed {
  logic [7:0] a;
} u_t;

module m(input u_t i);
endmodule
```

## Error Output

```
circt-verilog: /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/include/llvm/Support/Casting.h:650: decltype(auto) llvm::dyn_cast(From &) [To = circt::hw::InOutType, From = mlir::Type]: Assertion `detail::isPresent(Val) && "dyn_cast on a non-existent value"' failed.
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.	Program arguments: /edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/circt-verilog --ir-hw bug.sv
 #0 0x00005643cb08632f llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
 #1 0x00005643cb0872e9 llvm::sys::RunSignalHandlers()
 #2 0x00005643cb0872e9 SignalHandler(int, siginfo_t*, void*)
...
```

## Root Cause Analysis

The crash occurs in the following call chain:

```
#17 circt::hw::ModulePortInfo::sanitizeInOut() PortImplementation.h:177
#21 getModulePortInfo(mlir::TypeConverter const&, circt::moore::SVModuleOp) MooreToCore.cpp:259
#22 SVModuleOpConversion::matchAndRewrite() MooreToCore.cpp:276
#42 MooreToCorePass::runOnOperation() MooreToCore.cpp:2571
```

**Problematic code in `getModulePortInfo()` (MooreToCore.cpp:243-258):**

```cpp
static hw::ModulePortInfo getModulePortInfo(const TypeConverter &typeConverter,
                                            SVModuleOp op) {
  // ...
  for (auto port : moduleTy.getPorts()) {
    Type portTy = typeConverter.convertType(port.type);  // May return null!
    if (port.dir == hw::ModulePort::Direction::Output) {
      ports.push_back(hw::PortInfo({{port.name, portTy, port.dir}, resultNum++, {}}));
    } else {
      ports.push_back(hw::PortInfo({{port.name, portTy, port.dir}, inputNum++, {}}));
    }
  }
  return hw::ModulePortInfo(ports);  // Calls sanitizeInOut() with null type
}
```

When `portTy` is null (because the type converter doesn't support packed union types), it is still used to create a `hw::PortInfo`. Later, `sanitizeInOut()` attempts to `dyn_cast<hw::InOutType>(p.type)` on the null type, causing the assertion failure.

**Why Packed Union Conversion Fails:**

SystemVerilog's `packed union` types need special handling during type conversion. The Moore dialect's type converter likely doesn't have a registered conversion for packed union types, or the conversion returns failure/null for unsupported aggregate types.

**Fix Recommendation:**

Add null validation after type conversion in `getModulePortInfo()`:

```cpp
for (auto port : moduleTy.getPorts()) {
  Type portTy = typeConverter.convertType(port.type);
  if (!portTy) {
    op.emitOpError() << "failed to convert port type: " << port.type;
    return {};  // or return LogicalResult::failure()
  }
  // ... rest of code
}
```

## Environment

- **CIRCT Version**: 1.139.0
- **OS**: Linux 5.15.0
- **Architecture**: x86_64
- **Test Case Validation**:
  - ✅ Verilator: Valid SystemVerilog (no errors, no warnings)
  - ✅ Slang: Valid SystemVerilog (no errors, no warnings)

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
#17 circt::hw::ModulePortInfo::sanitizeInOut() PortImplementation.h:177
#21 getModulePortInfo(mlir::TypeConverter const&, circt::moore::SVModuleOp) MooreToCore.cpp:259
#22 SVModuleOpConversion::matchAndRewrite() MooreToCore.cpp:276
#23 mlir::ConversionPattern::dispatchTo1To1() DialectConversion.h
#24 mlir::OpConversionPattern::matchAndRewrite() DialectConversion.h:715
#25 mlir::PatternApplicator::matchAndRewrite() PatternApplicator.cpp
#26 (anonymous namespace)::OperationLegalizer::legalize() DialectConversion.cpp
#27 mlir::OperationConverter::convert() DialectConversion.cpp
#28 mlir::OperationConverter::convertOperations() DialectConversion.cpp
#29 applyConversion() DialectConversion.cpp
#30 mlir::applyFullConversion() DialectConversion.cpp
#31 (anonymous namespace)::MooreToCorePass::runOnOperation() MooreToCore.cpp:2571
```

</details>

## Related Issues

This issue appears to be part of a broader class of type conversion failures in the MooreToCore pass:

- **#8930**: [MooreToCore] Crash with sqrt/floor - Same `dyn_cast` assertion failure in MooreToCore, but triggers via ConversionOp rather than module port types (0.85 similarity)
- **#7535**: [MooreToCore] VariableOp lowered failed - Same MooreToCore pass and InOutType casting failures, different triggering construct (0.78 similarity) - **likely related**
- **#8382**: [FIRRTL] Crash with fstring type on port - Same `dyn_cast` assertion pattern during type conversion, but in FIRRTL dialect (0.65 similarity)

These issues suggest a pattern of missing null type validation after type conversion across multiple dialect conversions.

## Validation

- ✅ Minimal test case (6 lines, 87% reduction from original)
- ✅ Valid SystemVerilog syntax (verified by Verilator and Slang)
- ✅ Crash signature matches original error
- ✅ Reproduces consistently with `circt-verilog --ir-hw`

---
*This issue was generated with assistance from an automated bug reporter.*
