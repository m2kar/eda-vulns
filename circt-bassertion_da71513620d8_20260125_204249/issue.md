<!--
CIRCT Bug Report
Generated by circt-bug-reporter skill
-->

[Moore] Crash in MooreToCore when using string type as module output port

## Description

CIRCT crashes with a segmentation fault when processing a SystemVerilog module that uses a `string` type as a module output port. The crash occurs during the MooreToCore conversion pass when attempting to create an HW module with a port of type `sim::DynamicStringType`, which is a simulation type incompatible with hardware module ports.

**Crash Type**: assertion (SIGSEGV)
**Dialect**: Moore
**Failing Pass**: MooreToCore

## Steps to Reproduce

1. Save test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw bug.sv
   ```

## Test Case

```systemverilog
module test_module(
  input logic clk,
  input logic [31:0] data_in,
  output string str_out
);

  string str;

  always_comb begin
    str = "Hello";
  end

  assign str_out = str;

endmodule
```

## Error Output

```
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.	Program arguments: circt-verilog --ir-hw bug.sv
 #0 0x00007fd777cf78a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x2008a8)
 #1 0x00007fd777cf52f5 llvm::sys::RunSignalHandlers() (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x1fe2f5)
 #2 0x00007fd777cf8631 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0
 #3 0x00007fd777805330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007fd77bf198ae (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const MooreToCore.cpp:0:0
 #5 0x00007fd77bf19b93 llvm::LogicalResult mlir::ConversionPattern::dispatchTo1To1<mlir::OpConversionPattern<circt::moore::SVModuleOp>, circt::moore::SVModuleOp>(mlir::OpConversionPattern<circt::moore::SVModuleOp> const&, circt::moore::SVModuleOp, circt::moore::SVModuleOp::GenericAdaptor<llvm::ArrayRef<mlir::ValueRange>>, mlir::ConversionPatternRewriter&) (/opt/firtool-1.139.0/bin/../lib/libCIRCTMooreToCore.so+0x50b93)
 #6 0x00007fd77bf19530 mlir::OpConversionPattern<circt::moore::SVModuleOp>::matchAndRewrite(mlir::Operation*, llvm::ArrayRef<mlir::ValueRange>, mlir::ConversionPatternRewriter&) const (/opt/firtool-1.139.0/bin/../lib/libCIRCTMooreToCore.so+0x50530)
 #7 0x00007fd77a22b438 mlir::ConversionPattern::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&) const (/opt/firtool-1.139.0/bin/../lib/libMLIRTransformUtils.so+0x2a438)
 #8 0x00007fd77a1f58ed void llvm::function_ref<void ()>::callback_fn<mlir::PatternApplicator::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&, llvm::function_ref<bool (mlir::Pattern const&)>, llvm::function_ref<void (mlir::Pattern const&)>, llvm::function_ref<llvm::LogicalResult (mlir::Pattern const&)>)::$_0>(long) PatternApplicator.cpp:0:0
...
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)

**Cause**: CIRCT does not support string type as module ports for hardware synthesis, but lacks proper validation/error handling. StringType is converted to sim::DynamicStringType, which is a simulation type incompatible with hardware module ports.

**Evidence**:
- Test case has `output string str_out`
- TypeConverter converts StringType to sim::DynamicStringType (line 2277-2279 in MooreToCore.cpp)
- sim::DynamicStringType is a simulation type defined in the Sim dialect
- HW module ports expect hardware types (IntegerType, hw::ArrayType, etc.), not simulation types
- Crash occurs when creating hw::ModuleOp with sim::DynamicStringType port type

**Mechanism**:
The MooreToCore pass attempts to convert a Moore `SVModuleOp` (with a `string` port) to an HW `ModuleOp`. The TypeConverter correctly converts the string type to `sim::DynamicStringType` for simulation purposes. However, when creating the hardware module, the port type is still `sim::DynamicStringType`, which is incompatible with hardware module port expectations. Downstream code attempting to process this port (e.g., casting to `InOutType` or other HW types) fails because the type is invalid in the hardware context.

### Hypothesis 2 (Medium Confidence)

**Cause**: sim::DynamicStringType may be missing proper support in HW dialect's type system.

**Evidence**:
- Sim dialect types are generally used for simulation constructs, not synthesis
- HW dialect may not have handlers for Sim dialect types
- No explicit validation or error when passing Sim types to HW modules

### Hypothesis 3 (Low Confidence)

**Cause**: Type conversion pipeline may have a bug in handling mixed dialect types.

**Evidence**:
- Mixed dialect scenario: Moore to Sim to HW
- Type conversion itself works correctly
- Issue occurs during module construction, not type conversion itself

## Suggested Fix Directions

1. **Add validation in TypeConverter** (Recommended):
   - In `populateTypeConversion`, add a check that prevents conversion of StringType when used as a module port
   - Return a proper error message: "String type is not supported as a module port for hardware synthesis"

2. **Add validation in `getModulePortInfo`**:
   - Check if `portTy` is a valid hardware type before adding to `ports`
   - Reject `sim::DynamicStringType` and other simulation types with a clear error

3. **Mark simulation types as illegal for HW modules**:
   - In the `MooreToCore` pass's conversion target, mark operations with `sim::DynamicStringType` ports as illegal
   - This will cause the conversion framework to report an error rather than crash

4. **Improve error handling** (Short-term fix):
   - Add assertions with better error messages in `getModulePortInfo`
   - Check for invalid types before creating `hw::PortInfo`
   - At minimum, change the crash to a proper diagnostic error

## Environment

- **CIRCT Version**: CIRCT firtool-1.139.0, LLVM 22.0.0git
- **OS**: Linux 5.15.0-164-generic
- **Architecture**: x86_64

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
#4  SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const MooreToCore.cpp:0:0
 #5  SVModuleOpConversion::matchAndRewrite(mlir::Operation*, llvm::ArrayRef<mlir::ValueRange>, mlir::ConversionPatternRewriter&) const
 #6  SVModuleOpConversion::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&) const
 #7  ConversionPattern::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&) const
 #8  PatternApplicator::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&, llvm::function_ref<bool (mlir::Pattern const&)>, llvm::function_ref<void (mlir::Pattern const&)>, llvm::function_ref<llvm::LogicalResult (mlir::Pattern const&)>)::$_0>(long) PatternApplicator.cpp:0:0
...
```

</details>

## Related Issues

While searching for duplicates, several related issues were found that discuss string type support in CIRCT, but none specifically address this crash scenario:

- #8283 - [ImportVerilog] Cannot compile forward declared string type (Similarity: 3.0)
  - Discusses string type issues in MooreToCore
  - **Different**: Focuses on forward declarations, not output port crashes

- #8332 - [MooreToCore] Support for StringType from moore to llvm dialect (Similarity: 3.0)
  - Feature request for string type support
  - **Different**: Feature request, not a bug report for crash

- #5640 - [SV] Introduce SystemVerilog `string` type (Similarity: 2.0)
  - Discussion about introducing string type support
  - **Different**: Design discussion, not a crash report

- #8292 - [MooreToCore] Support for Unsized Array Type (Similarity: 2.0)
- #9206 - [ImportVerilog] moore.conversion generated instead of moore.int_to_string (Similarity: 2.0)

## Additional Notes

- The test case uses valid SystemVerilog syntax (verified by slang and Verilator)
- Other tools (Verilator, slang) accept this code without errors
- The issue is that CIRCT crashes instead of providing a clear error message about unsupported features
- String types are primarily used for simulation purposes in SystemVerilog
- Hardware synthesis typically requires fixed-width types
- Expected behavior: CIRCT should either support string type ports for simulation or reject them with a clear error message

## Validation Information

- **Syntax Check**: ✅ Valid (verified by slang: 0 errors, 0 warnings)
- **Cross-tool**: ✅ Verilator accepts the test case (exit code 0)
- **Classification**: report (confirmed bug)

---

*This issue was generated with assistance from an automated bug reporter.*
