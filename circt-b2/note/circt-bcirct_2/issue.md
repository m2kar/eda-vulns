<!-- 
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
  
  ⚠️ DUPLICATE OF #6343 - DO NOT SUBMIT AS NEW ISSUE
-->

<!-- Title: [Calyx] Segfault in SCFToCalyx when func.call exists inside loop body -->

## ⚠️ DUPLICATE NOTICE

**This bug is a confirmed duplicate of [Issue #6343](https://github.com/llvm/circt/issues/6343)**

| Field | Value |
|-------|-------|
| Duplicate Of | [#6343](https://github.com/llvm/circt/issues/6343) |
| Similarity Score | **9.5 / 10** |
| Original Status | OPEN |
| Action | **DO NOT submit new issue** |

---

## Description

`lower-scf-to-calyx` pass crashes with a segmentation fault when processing a function containing `func.call` operations inside a loop body. The crash occurs in `BuildControl::buildCFGControl` when constructing `mlir::SuccessorRange` with an invalid Block pointer.

This is a known issue: the SCFToCalyx pass does not properly handle external function calls within loop bodies. When an `affine.for` loop containing `func.call` is lowered through `--lower-affine` and `--scf-for-to-while`, the resulting SCF while loop triggers a null pointer access during Calyx control flow construction.

**Crash Type**: Segmentation Fault (SIGSEGV)  
**Dialect**: Calyx  
**Failing Pass**: `lower-scf-to-calyx` (SCFToCalyx)

## Steps to Reproduce

1. Save the test case below as `test.mlir`
2. Run:
   ```bash
   mlir-opt --lower-affine --scf-for-to-while test.mlir | \
     circt-opt --pass-pipeline='builtin.module(lower-scf-to-calyx{top-level-function=f})'
   ```

## Test Case

```mlir
// Minimal test case: func.call inside affine.for triggers SCFToCalyx segfault
// Duplicate of https://github.com/llvm/circt/issues/6343

func.func private @ext()

func.func @f() {
  affine.for %i = 0 to 1 {
    func.call @ext() : () -> ()
  }
  return
}
```

**Size**: 11 lines (minimized from 22 lines, 50% reduction)

## Error Output

```
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.	Program arguments: /opt/firtool-1.139.0/bin/circt-opt --pass-pipeline=builtin.module(lower-scf-to-calyx{top-level-function=f})
 #0 0x00007fc013a018a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
 #1 0x00007fc0139ff2f5 llvm::sys::RunSignalHandlers()
 #2 0x00007fc013a02631 SignalHandler(int, siginfo_t*, void*)
 #3 0x00007fc01350f330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007fc013c4a4f3 mlir::SuccessorRange::SuccessorRange(mlir::Block*)
 #5 0x00007fc0199004f7 circt::scftocalyx::BuildControl::buildCFGControl(...) const
 #6 0x00007fc019900256 circt::scftocalyx::BuildControl::partiallyLowerFuncToComp(...) const
...
```

## Root Cause Analysis

### Primary Hypothesis (High Confidence)

**Cause**: SCFToCalyx does not support `func.call` operations inside loop bodies

**Evidence**:
- GitHub Issue #6343 reports identical crash pattern with `llvm.smax` function call
- Maintainer confirmed: *"there is an actual bug somewhere in scf-to-calyx"*
- Crash occurs in `buildCFGControl` when traversing CFG containing `func.call`

**Mechanism**: `buildCFGControl` encounters `func.call` which introduces unexpected CFG edges or Block successor structure, leading to null pointer access in `SuccessorRange` constructor.

### Secondary Hypothesis (Medium Confidence)

**Cause**: Calyx model lacks support for external function call instantiation

**Evidence**:
- Maintainer mentioned: *"it should be fairly simple to integrate function calls in the Calyx model"*
- This implies the feature is not yet implemented

## Environment

- **CIRCT Version**: firtool-1.139.0
- **OS**: Linux
- **Architecture**: x86_64

## Stack Trace

<details>
<summary>Click to expand full stack trace</summary>

```
 #0 0x00007fc013a018a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
 #1 0x00007fc0139ff2f5 llvm::sys::RunSignalHandlers()
 #2 0x00007fc013a02631 SignalHandler(int, siginfo_t*, void*)
 #3 0x00007fc01350f330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007fc013c4a4f3 mlir::SuccessorRange::SuccessorRange(mlir::Block*)
 #5 0x00007fc0199004f7 circt::scftocalyx::BuildControl::buildCFGControl(...) const
 #6 0x00007fc019900256 circt::scftocalyx::BuildControl::partiallyLowerFuncToComp(...) const
 #7 0x00007fc0187e298d circt::calyx::FuncOpPartialLoweringPattern::partiallyLower(...) const
 #8 0x00007fc0198f5047 circt::calyx::PartialLoweringPattern<mlir::func::FuncOp, mlir::OpRewritePattern>::matchAndRewrite(...) const
 #9 0x00007fc015f6b8ed mlir::PatternApplicator::matchAndRewrite(...)
#10 0x00007fc015f68774 mlir::PatternApplicator::matchAndRewrite(...)
#11 0x00007fc015fc04a7 GreedyPatternRewriteDriver::processWorklist()
#12 0x00007fc015fbdfd9 mlir::applyPatternsGreedily(...)
#13 0x00007fc0198ef341 circt::SCFToCalyxPass::runOnOperation()
#14 0x00007fc015d5b2a5 mlir::detail::OpToOpPassAdaptor::run(...)
#15 0x00007fc015d5e7a9 mlir::PassManager::run(...)
```

</details>

## Related Issues

- **#6343**: [MLIR lowering issue](https://github.com/llvm/circt/issues/6343) - **DUPLICATE OF THIS** (Score: 9.5)
- #5031: [scf-to-calyx] Mark `cf` operations illegal

## Comparison with #6343

| Aspect | This Bug | Issue #6343 |
|--------|----------|-------------|
| Crash Location | `buildCFGControl` | `buildCFGControl` |
| Failing Pass | `lower-scf-to-calyx` | `lower-scf-to-calyx` |
| Trigger | `func.call` in loop | `func.call @llvm.smax.i32` in loop |
| Input Dialect | affine | affine |
| Crash Type | Segfault | Segfault |

## Recommendation

⚠️ **DO NOT create a new issue.**

**Recommended Actions**:
1. ✅ Add this minimized test case (11 lines) as a comment to [Issue #6343](https://github.com/llvm/circt/issues/6343)
2. Monitor Issue #6343 for fix progress
3. Workaround: Avoid `func.call` inside loops when targeting Calyx, or inline the function logic

## Files for Reference

| File | Description |
|------|-------------|
| `bug.mlir` | Minimized test case (11 lines) |
| `error.log` | Full crash output |
| `root_cause.md` | Detailed analysis report |
| `analysis.json` | Structured analysis data |

---
*This report was generated with assistance from circt-bug-reporter skill.*  
*Classification: Duplicate of #6343 (Similarity: 95%)*
