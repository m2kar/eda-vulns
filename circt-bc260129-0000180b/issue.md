<!--
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Moore] hw.bitcast error with overflow bitwidth from self-referential typedef -->

## Description

CIRCT compiler fails to lower SystemVerilog code containing a self-referential typedef in a parameterized class when a delay statement is present. The error manifests as a bitcast operation attempting to use an overflow bitwidth value (i1073741823 = 2^30 - 1), suggesting unbounded recursion in type size calculation.

**Crash Type**: assertion/error
**Dialect**: Moore
**Failing Pass**: HoistSignals (LLHD dialect)

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   export PATH=/opt/llvm-22/bin:$PATH && export PATH=/opt/firtool/bin:$PATH && circt-verilog --ir-hw test.sv 2>&1
   ```

## Test Case

```systemverilog
package pkg;
  class container #(type T = int);
    T data;
  endclass

  class my_class;
    typedef container#(pkg::my_class) my_type;
  endclass
endpackage

module System;
  import pkg::*;

  my_class::my_type class_obj;

  initial begin
    class_obj = new();
    #1;
  end
endmodule
```

## Error Output

```
bug.sv:6:9: remark: Class builtin functions (needed for randomization, constraints, and covergroups) are not yet supported and will be dropped during lowering.
  class my_class;
        ^
bug.sv:16:3: error: 'hw.bitcast' op result #0 must be Type wherein the bitwidth in hardware is known, but got '!llvm.ptr'
  initial begin
  ^
bug.sv:16:3: note: see current operation: %6 = "hw.bitcast"(%5) : (i1073741823) -> !llvm.ptr
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)
**Cause**: The Moore dialect's type resolution lacks cycle detection for self-referential typedefs, leading to infinite recursion during bit width calculation when processing delay statements.

**Evidence**:
- Self-referential typedef creates circular dependency: `typedef container#(pkg::my_class) my_type` → `container#(pkg::my_class)` → `my_type`
- The overflow value `1073741823` = 2^30 - 1 suggests unbounded recursion or signed integer overflow in size accumulation
- The error occurs when delay `#1` is present in the initial block
- Without delays, the same type compiles successfully (no hoisting of drives needed)
- HoistSignals pass attempts to materialize drive values for delays, calling `hw::getBitWidth()`
- `hw::getBitWidth()` returns -1 on error (causing assertion) or overflow (as seen in current version)

**Mechanism**:
1. When a delay statement (`#1`) is present, LLHD's HoistSignals pass is invoked to hoist drive operations
2. The pass needs to materialize drive values with default constants
3. To create a constant for the class type, it calls `hw::getBitWidth(type)`
4. The type resolution attempts to calculate size of `container#(pkg::my_class)` by recursively expanding the typedef
5. Without cycle detection, this expansion continues indefinitely
6. Either returns -1 (triggering assertion in older versions) or accumulates size until overflow (current version)
7. The bitcast operation then attempts to use this invalid width, causing the error

## Environment

- **CIRCT Version**: LLVM 22.0.0git, CIRCT firtool-1.139.0
- **OS**: Linux
- **Architecture**: x86_64

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
#0  circt-verilog: /home/zhiqing/edazz/eda-vulns/circt-bc260129-0000180b/origin/error.txt:11: Assertion `numBits >= 0' failed.
#1  (anonymous namespace)::DriveHoister::hoistDrives()::$_0::operator()(DriveValue)::(lambda)::operator()(auto) const [type:auto = mlir::Type]: /home/zhiqing/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Dialect/LLHD/Transforms/HoistSignals.cpp:549:14: void (anonymous namespace)::DriveHoister::hoistDrives()::$_0::operator()(DriveValue)::(lambda)::operator()(auto) const [type:auto = mlir::Type]
#2  mlir::LogicalResult mlir::detail::OpToOpPassAdaptor::run(mlir::Pass*, mlir::Operation*, mlir::AnalysisManager, bool, unsigned int)::$_3::operator()()
#3  ...
```

</details>

## Related Issues

- [#9287](https://github.com/llvm/circt/issues/9287) - [HW] Make `hw::getBitWidth` use std::optional vs -1 (discusses API improvements for getBitWidth)
- [#9570](https://github.com/llvm/circt/issues/9570) - [Moore] Assertion in MooreToCore when module uses packed union type as port (about Moore type handling)
- [#9467](https://github.com/llvm/circt/issues/9467) - [circt-verilog][arcilator] `arcilator` fails to lower `llhd.constant_time` generated from simple SV delay (about delays in LLHD)

---
*This issue was generated with assistance from an automated bug reporter.*
