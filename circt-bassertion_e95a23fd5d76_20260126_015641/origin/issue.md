<!--
  CIRCT Bug Report (Historical)
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Arc] arcilator crash in LowerState pass with llhd.ref<i1> type (fixed) -->

## Description

**Historical Bug - Fixed in Current Version**

This issue documents a crash that occurred in an older version of CIRCT (circt-verilog 1.139.0) when processing SystemVerilog modules with `inout` ports through the arcilator tool. The crash has been verified to be **fixed** in the current CIRCT toolchain.

### Original Issue
The crash occurred in arcilator's `LowerState` pass when attempting to create a `StateType` for module arguments. The pass failed with an assertion error when encountering `!llhd.ref<i1>` types produced by `circt-verilog --ir-hw` for `inout` ports.

**Crash Type**: assertion
**Dialect**: Arc
**Failing Pass**: LowerState
**Status**: ✅ Fixed (no longer reproducible on current toolchain)

## Steps to Reproduce

1. Save test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv | arcilator
   ```
3. Expected to fail on older CIRCT versions with assertion error
4. On current CIRCT version (firtool-1.139.0), this completes successfully

## Test Case

```systemverilog
typedef struct packed {
  logic [7:0] data;
} my_struct_t;

module top (
  inout wire c,
  output logic [7:0] out
);
  
  always_comb begin
    out = my_struct_t'(8'h00);
  end
  
endmodule
```

## Error Output (Original)

```
circt-verilog: lib/Dialect/Arc/Transforms/LowerState.cpp:219: void circt::arc::ModuleLowering::run(): Assertion `succeeded( ConcreteT::verifyInvariants(getDefaultDiagnosticEmitFn(ctx), args...))' failed.
state type must have a known bit width; got '!llhd.ref<i1>'
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)
**Cause**: Arcilator's LowerState pass did not support inout ports represented as `!llhd.ref<T>` types. The `computeLLVMBitWidth()` function in `ArcTypes.cpp` only handled `ClockType`, `IntegerType`, `ArrayType`, and `StructType`, but lacked a case for `llhd::RefType`.

**Evidence**:
- Error message: "state type must have a known bit width; got '!llhd.ref<i1>'"
- Stack trace shows crash in `StateType::get()` called from `ModuleLowering::run()`
- `computeLLVMBitWidth()` has no case for `llhd::RefType`
- Test case contains `inout wire c` which maps to `!llhd.ref<i1>`

### Mechanism
When `circt-verilog --ir-hw` processes the SystemVerilog input, it converts `inout` ports to LLHD reference types (`!llhd.ref<i1>`). When this IR is passed to arcilator, the `LowerState` pass attempts to create `StateType` objects for each module argument. The `StateType::verifyInvariants()` function calls `computeLLVMBitWidth()` which fails because it doesn't recognize `llhd::RefType` as a valid type for state computation.

### Fix
The issue was resolved by adding support for `llhd::RefType` in the arcilator type handling, likely as part of the broader LLHD refactoring (see PR #9081).

## Environment

- **Original CIRCT Version**: circt-verilog 1.139.0 (affected version)
- **Current CIRCT Version**: firtool-1.139.0 / LLVM 22.0.0git (verified fixed)
- **OS**: Linux
- **Architecture**: x86_64

## Validation Results

| Check | Result |
|--------|--------|
| Syntax (slang) | ✅ Valid |
| Verilator | ✅ Pass |
| Icarus Verilog | ✅ Pass |
| Unsupported Features | None |
| Classification | historical_bug (fixed) |

The test case is valid SystemVerilog and passes all cross-tool validation.

## Related Issues

- #8825: [LLHD] Switch from hw.inout to a custom signal reference type - Discusses llhd.ref type design
- #9081: [LLHD] Add new RefType to replace hw::InOutType - PR that introduced llhd.ref type
- #8286: [circt-verilog][llhd][arcilator] Verilog-to-LLVM lowering issues - Related arcilator issues

## Impact

**Historical Impact**: This crash prevented using arcilator with any SystemVerilog module containing `inout` ports, which is a common feature for bidirectional signals.

**Current Status**: ✅ Resolved - arcilator now properly handles LLHD ref types for inout ports.

## Regression Testing

This test case should be added to the CIRCT test suite as a regression test to ensure arcilator continues to support `inout` ports correctly.

---
*This issue documents a historical bug that has been fixed. Generated with assistance from the circt-bug-reporter skill.*
