<!--
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Arc] Assertion failure in LowerState pass: StateType must have known bit width, got '!llhd.ref<i1>' -->

## Description

CIRCT's Arc dialect crashes when lowering SystemVerilog designs with `inout` ports that use tri-state assignments. The crash occurs in the `LowerState` pass when `StateType::get()` is called with an LLHD reference type (`!llhd.ref<i1>`), which fails verification because the type doesn't have a known bit width.

**Trigger**: A SystemVerilog `inout` wire with a tri-state assignment (`assign c = a ? 1'bz : 1'b0`) creates an LLHD reference type that is incompatible with Arc's `StateType`.

**Crash Type**: assertion
**Dialect**: Arc
**Failing Pass**: LowerState (LowerState.cpp:219)
**Component**: `arc::StateType::get()`

**Note**: This bug appears to be fixed in the current CIRCT version (firtool-1.139.0). The issue report is being generated for documentation purposes.

## Steps to Reproduce

1. Save test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv | arcilator
   ```

## Test Case

```systemverilog
// Minimized test case for CIRCT arc::StateType assertion failure
// Original: 260128-00000ed6
// Trigger: inout wire with tri-state assignment creating !llhd.ref<i1>
module MixPorts(
  input  logic clk,
  input  logic a,
  inout  wire  c
);
  // Tri-state assignment to inout wire - creates !llhd.ref<i1> type
  assign c = a ? 1'bz : 1'b0;
endmodule
```

## Error Output

```
<unknown>:0: error: state type must have a known bit width; got '!llhd.ref<i1>'
arcilator: /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/llvm/llvm/../mlir/include/mlir/IR/StorageUniquerSupport.h:180: static ConcreteT mlir::detail::StorageUserBase<circt::arc::StateType, mlir::Type, circt::arc::detail::StateTypeStorage, mlir::detail::TypeUniquer>::get(MLIRContext *, Args &&...) [ConcreteT = circt::arc::StateType, BaseT = mlir::Type, StorageT = circt::arc::detail::StateTypeStorage, UniquerT = mlir::detail::TypeUniquer, Traits = <>, Args = <mlir::Type &>]: Assertion `succeeded( ConcreteT::verifyInvariants(getDefaultDiagnosticEmitFn(ctx), args...))' failed.
```

## Root Cause Analysis

### Summary

The crash occurs when the LowerState pass attempts to allocate state for a value with type `!llhd.ref<i1>`. The Arc dialect's `StateType` requires its inner type to have a known bit width (verified by `computeLLVMBitWidth()`), but the `llhd::RefType` is not handled in the bit width computation, causing it to return `nullopt` and fail the assertion.

### Hypothesis

**High Confidence**: The bug is a missing handler in `computeLLVMBitWidth()` or missing validation before calling `StateType::get()`.

**Evidence**:
- Test case uses `inout wire c` with tri-state assignment: `assign c = a ? 1'bz : 1'b0;`
- This construction creates an `!llhd.ref<i1>` type in the IR
- Assertion fails at `StateType::get()` in `LowerState.cpp:219`
- Error message: "state type must have a known bit width; got '!llhd.ref<i1>'"
- Stack trace shows `verifyInvariants` failure in `StorageUniquerSupport.h:180`

**Call Chain**:
1. `LowerStatePass::runOnOperation()` (LowerState.cpp:1198)
2. `ModuleLowering::run()` (LowerState.cpp:219)
3. `StateType::get(result.getType())` (ArcTypes.cpp.inc:108)
4. `verifyInvariants()` â†’ assertion fails

**Root Cause**: `computeLLVMBitWidth()` in `ArcTypes.cpp` doesn't handle `llhd::RefType`, returning `nullopt`, which causes `StateType::verify()` to fail.

**Suggested Fixes**:
1. Add validation in `LowerState.cpp` to reject LLHD reference types with proper diagnostic before calling `StateType::get()`
2. Extend `computeLLVMBitWidth()` to handle `llhd::RefType` by unwrapping to get the underlying type's bit width

## Environment

- **CIRCT Version**: firtool-1.139.0 (current, bug appears to be fixed)
- **CIRCT Version at Crash**: circt-1.139.0 (original crash version)
- **LLVM Version**: 22.0.0git
- **OS**: Linux
- **Architecture**: x86_64

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
#0  0x00005583aaf8023f llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
#1  0x00005583aaf81379 llvm::sys::RunSignalHandlers()
#2  0x00005583aaf81379 SignalHandler(int, siginfo_t*, void*)
#3  0x00007f1818fe5330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
#4  0x00007f181903eb2c __pthread_kill_implementation ./nptl/pthread_kill.c:44:76
#5  0x00007f181903eb2c __pthread_kill_internal ./nptl/pthread_kill.c:78:10
#6  0x00007f181903eb2c pthread_kill ./nptl/pthread_kill.c:89:10
#7  0x00007f1818fe527e raise ./signal/../sysdeps/posix/raise.c:27:6
#8  0x00007f1818fc88ff abort ./stdlib/abort.c:81:7
#9  0x00005583ab6d1bbc
#10 0x00005583ab6d1ae9 circt::arc::StateType::get(mlir::Type) /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/build/tools/circt/include/circt/Dialect/Arc/ArcTypes.cpp.inc:108:3
#11 0x00005583ab73cf5c (anonymous namespace)::ModuleLowering::run() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Dialect/Arc/Transforms/LowerState.cpp:219:66
#12 0x00005583ab73cf5c (anonymous namespace)::LowerStatePass::runOnOperation() /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/lib/Dialect/Arc/Transforms/LowerState.cpp:1198:41
#13 0x00005583af0d3782 mlir::detail::OpToOpPassAdaptor::run(mlir::Pass*, mlir::Operation*, mlir::AnalysisManager, bool, unsigned int)::$_3::operator()()
#14 0x00005583af0c57b1 mlir::detail::OpToOpPassAdaptor::run()
#15 0x00005583af0c677f mlir::detail::OpToOpPassAdaptor::runPipeline()
#16 0x00005583af0d01e9 mlir::PassManager::runPasses()
#17 0x00005583af0cf431 mlir::PassManager::run()
#18 0x00005583aaea92d3 processBuffer()
#19 0x00005583aaea8395 processInputSplit()
#20 0x00005583aaea57b4 processInput()
#21 0x00005583aaea57b4 executeArcilator()
#22 0x00005583aaea4e0e main /home/zhiqing/edazz/FeatureFuzz-SV/target/circt-1.139.0-src/tools/arcilator/arcilator.cpp:697:8
```

</details>

## Related Issues

- #9246: [Arc] llhd.sig.array_slice width verification (0.52 similarity - different error)
- #5053: [Arc] LowerState: combinatorial cycle (0.45 similarity - same file, different bug)
- #9395: [circt-verilog][arcilator] Assertion failure (0.48 similarity - arcilator related)
- #9466: [arcilator] llhd.constant_time lowering (0.40 similarity - arcilator legalization)
- #9469: [arcilator] Array indexing in always_ff (0.38 similarity - arcilator llhd legalization)

**Note**: No exact duplicate found. This is a distinct issue involving `StateType` validation with LLHD reference types.

## Additional Information

**Test Case Statistics**:
- Original test case: 26 lines
- Minimized test case: 11 lines (57.7% reduction)
- Key features: inout port, tri-state assignment, creates `!llhd.ref<i1>` type

**Validation**:
- Syntax: Valid SystemVerilog
- Verilator: PASS
- Slang: PASS
- Icarus Verilog: PASS
- CIRCT (current): PASS (bug fixed)

**Classification**: Historical bug (appears to be fixed in current version)

---
*This issue was generated with assistance from an automated bug reporter.*
