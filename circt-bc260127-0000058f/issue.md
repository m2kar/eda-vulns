<!--
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
  Bug ID: bc260127-0000058f
-->

# [Moore] Assertion failure in MooreToCore with packed union type as module port

## Description

CIRCT's `circt-verilog` crashes when processing a SystemVerilog module with **packed union** types as port types. The MooreToCore conversion pass lacks type conversion support for `PackedUnionType`, resulting in a null type being passed to `hw::ModulePortInfo`, which then triggers an assertion failure when attempting `dyn_cast` on a non-existent value.

The crash occurs during MooreToCore dialect conversion when processing module port information. The type converter doesn't have a registered conversion for `PackedUnionType`, so `convertType()` returns null. This null type is then used in `ModulePortInfo::sanitizeInOut()` where a `dyn_cast<hw::InOutType>` operation triggers an assertion.

**Crash Type**: assertion
**Dialect**: Moore
**Failing Pass**: MooreToCore

## Steps to Reproduce

1. Save test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog test.sv --ir-hw
   ```

## Test Case

```systemverilog
// Minimal reproducer: packed union type as module port crashes MooreToCore pass
// Bug: Missing type conversion for PackedUnionType in MooreToCore

typedef union packed {
  logic a;
} u;

module m(input u x);
endmodule
```

## Error Output

```
PLEASE submit a bug report to https://github.com/llvm/circt and include the crash backtrace.
Stack dump:
0.	Program arguments: /opt/firtool/bin/circt-verilog --ir-hw /home/zhiqing/edazz/eda-vulns/circt-bc260127-0000058f/bug.sv
 #0 0x00007f99f47f58a8 llvm::sys::PrintStackTrace(llvm::raw_ostream&, int) (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x2008a8)
 #1 0x00007f99f47f32f5 llvm::sys::RunSignalHandlers() (/opt/firtool-1.139.0/bin/../lib/libLLVMSupport.so+0x1fe2f5)
 #2 0x00007f99f47f6631 SignalHandler(int, siginfo_t*, void*) Signals.cpp:0:0
 #3 0x00007f99f4303330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007f99f8a178ae (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const MooreToCore.cpp:0:0
...
circt-verilog: /opt/firtool-1.139.0/bin/../include/circt/Dialect/HW/PortImplementation.h:177: decltype(auto) llvm::dyn_cast(From &) [To = circt::hw::InOutType, From = mlir::Type]: Assertion `detail::isPresent(Val) && "dyn_cast on a non-existent value"' failed.
```

## Root Cause Analysis

### Primary Issue: Missing Type Conversion for `PackedUnionType`

The MooreToCore type converter (MooreToCore.cpp:2256-2381) registers conversions for many types but **does NOT include `PackedUnionType`**:

- `IntType` - Supported
- `ArrayType` - Supported
- `StructType` - Supported
- `UnpackedStructType` - Supported
- `PackedUnionType` - **NOT SUPPORTED** (missing conversion)

When `typeConverter.convertType()` is called on a `PackedUnionType`, it returns a **null Type** because no conversion is registered.

### Secondary Issue: No Null Check

The `getModulePortInfo()` function (MooreToCore.cpp:233-259) does not check if `typeConverter.convertType()` returns null before using the result. This allows the invalid type to propagate to `ModulePortInfo`, causing the crash when `sanitizeInOut()` is called.

### Crash Location

The assertion failure occurs at:
- **File**: `include/circt/Dialect/HW/PortImplementation.h`
- **Line**: 177
- **Function**: `circt::hw::ModulePortInfo::sanitizeInOut`

The call chain leading to the crash:
```
SVModuleOpConversion::matchAndRewrite() @ MooreToCore.cpp:276
  └─> getModulePortInfo() @ MooreToCore.cpp:259
       └─> hw::ModulePortInfo constructor
            └─> sanitizeInOut() @ PortImplementation.h:177
                 └─> dyn_cast<hw::InOutType>(p.type) // FAILS: p.type is null
```

## Environment

- **CIRCT Version**: firtool-1.139.0
- **OS**: Linux 5.15.0
- **Architecture**: x86_64

### Validation Results

The test case has been validated as valid SystemVerilog:
- **Slang 10.0.6+3d7e6cd2e**: ✅ Pass - Build succeeded: 0 errors, 0 warnings
- **Verilator 5.022**: ✅ Pass - lint-only completed successfully
- **CIRCT --ir-moore**: ✅ Pass - Moore IR generated successfully (union type recognized)
- **CIRCT --ir-hw**: ❌ CRASH - Assertion failure in MooreToCore conversion

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
 #4 0x00007f99f8a178ae (anonymous namespace)::SVModuleOpConversion::matchAndRewrite(circt::moore::SVModuleOp, circt::moore::SVModuleOpAdaptor, mlir::ConversionPatternRewriter&) const MooreToCore.cpp:0:0
 #5 0x00007f99f8a17b93 llvm::LogicalResult mlir::ConversionPattern::dispatchTo1To1<mlir::OpConversionPattern<circt::moore::SVModuleOp>, circt::moore::SVModuleOp>(mlir::OpConversionPattern<circt::moore::SVModuleOp> const&, circt::moore::SVModuleOp, circt::moore::SVModuleOp::GenericAdaptor<llvm::ArrayRef<mlir::ValueRange>>, mlir::ConversionPatternRewriter&) (/opt/firtool-1.139.0/bin/../lib/libCIRCTMooreToCore.so+0x50b93)
 #6 0x00007f99f8a17530 mlir::OpConversionPattern<circt::moore::SVModuleOp>::matchAndRewrite(mlir::Operation*, llvm::ArrayRef<mlir::ValueRange>, mlir::ConversionPatternRewriter&) const (/opt/firtool-1.139.0/bin/../lib/libCIRCTMooreToCore.so+0x50530)
 #7 0x00007f99f6d29438 mlir::ConversionPattern::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&) const (/opt/firtool-1.139.0/bin/../lib/libMLIRTransformUtils.so+0x2a438)
 #8 0x00007f99f6cf38ed void llvm::function_ref<void ()>::callback_fn<mlir::PatternApplicator::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&, llvm::function_ref<bool (mlir::Pattern const&)>, llvm::function_ref<void (mlir::Pattern const&)>, llvm::function_ref<llvm::LogicalResult (mlir::Pattern const&)>)::$_0>(long) PatternApplicator.cpp:0:0
 #9 0x00007f99f6cf0774 mlir::PatternApplicator::matchAndRewrite(mlir::Operation*, mlir::PatternRewriter&, llvm::function_ref<bool (mlir::Pattern const&)>, llvm::function_ref<void (mlir::Pattern const&)>, llvm::function_ref<llvm::LogicalResult (mlir::Pattern const&)>) (/opt/firtool-1.139.0/bin/../lib/libMLIRRewrite.so+0x7774)
#10 0x00007f99f6d2ac6f (anonymous namespace)::OperationLegalizer::legalize(mlir::Operation*) DialectConversion.cpp:0:0
#11 0x00007f99f6d2a470 mlir::OperationConverter::convert(mlir::Operation*, bool) (/opt/firtool-1.139.0/bin/../lib/libMLIRTransformUtils.so+0x2b470)
#12 0x00007f99f6d2adae mlir::OperationConverter::convertOperations(llvm::ArrayRef<mlir::Operation*>) (/opt/firtool-1.139.0/bin/../lib/libMLIRTransformUtils.so+0x2bdae)
#13 0x00007f99f6d388e4 void llvm::function_ref<void ()>::callback_fn<applyConversion(llvm::ArrayRef<mlir::Operation*>, mlir::ConversionTarget const&, mlir::FrozenRewritePatternSet const&, mlir::ConversionConfig, (anonymous namespace)::OpConversionMode)::$_0>(long) DialectConversion.cpp:0:0
#14 0x00007f99f6d2ff7d applyConversion(llvm::ArrayRef<mlir::Operation*>, mlir::ConversionTarget const&, mlir::FrozenRewritePatternSet const&, mlir::ConversionConfig, (anonymous namespace)::OpConversionMode) DialectConversion.cpp:0:0
#15 0x00007f99f6d300fe mlir::applyFullConversion(mlir::Operation*, mlir::ConversionTarget const&, mlir::FrozenRewritePatternSet const&, mlir::ConversionConfig) (/opt/firtool-1.139.0/bin/../lib/libMLIRTransformUtils.so+0x310fe)
#16 0x00007f99f89e9231 (anonymous namespace)::MooreToCorePass::runOnOperation() MooreToCore.cpp:0:0
```

</details>

## Related Issues

Several similar MooreToCore type conversion issues exist:

- #8930 - [MooreToCore] Crash with sqrt/floor (Score: 8/10)
  - Same dyn_cast assertion failure in MooreToCore pass
  - Different missing type (math operations vs packed union types)

- #7535 - [MooreToCore] VariableOp lowered failed (Score: 7/10)
  - MooreToCore conversion failure with struct types on ports
  - Same InOutType dyn_cast pattern

- #8382 - [FIRRTL] Crash with fstring type on port (Score: 6/10)
  - Similar assertion failure on unsupported port type
  - Different dialect (FIRRTL) but same failure pattern

This is a new issue specifically for **PackedUnionType** missing from the MooreToCore type converter.

---

**Suggested Tags**: `Moore`, `crash`, `found-by-fuzzing`
