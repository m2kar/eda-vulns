<!-- 
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Arc] Arcilator timeout in LowerState with packed struct partial field assignment -->

## Description

CIRCT's arcilator pipeline enters an infinite loop (60s timeout) when lowering SystemVerilog code that uses partial field assignment to packed structs in `always_comb` blocks.

The issue occurs when a packed struct field is assigned in an `always_comb` block while another unassigned field is read. During lowering, the `hw.struct_inject` operation generated for partial field assignments creates a false combinational loop, causing the arcilator LowerState pass to enter an infinite loop during worklist processing.

**Crash Type**: timeout (60s)
**Dialect**: Arc / SystemVerilog
**Failing Pass**: arcilator (LowerState)

This is a genuine bug - the test case is valid SystemVerilog code that compiles successfully with Slang, Verilator, and Icarus Verilog, but causes CIRCT's arcilator to hang indefinitely.

## Steps to Reproduce

1. Save test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv | arcilator | opt -O0 | llc -O0 --filetype=obj
   ```

## Test Case

```systemverilog
module M(output logic O);
  typedef struct packed { logic a; logic b; } S;
  S s;
  always_comb s.b = 0;
  assign O = s.a;
endmodule
```

## Error Output

```
Compilation timed out after 60s
Exit code: 124

Command: /opt/firtool/bin/circt-verilog --ir-hw test.sv | /opt/firtool/bin/arcilator | /opt/firtool/bin/opt -O0 | /opt/firtool/bin/llc -O0 --filetype=obj
...
```

## Root Cause Analysis

### Problem Pattern

Partial assignment to a packed struct field (`s.b = 0`) while reading an unassigned field (`s.a`) creates a false combinational loop. During lowering, this pattern generates `hw.struct_inject` operations that create cyclic dependencies in the dataflow graph.

### Technical Details

When the SystemVerilog is lowered to MLIR IR:
1. The packed struct becomes an `hw.struct` type
2. Partial field assignment (`s.b = 0`) becomes `hw.struct_inject %current["b"], %c0`
3. The inject operation reads the current struct value to update a single field
4. Since the struct is self-referential in comb logic, this creates a cycle

The arcilator LowerState pass in `LowerState.cpp` uses worklist-based traversal. When it encounters this cyclic dependency pattern, the worklist may grow indefinitely without triggering the cycle detection check, leading to a timeout.

### Key Findings

- **Critical discovery**: Using continuous `assign` instead of `always_comb` does NOT trigger the bug
- The `always_comb` block is essential for triggering the false combinational loop
- The same pattern works correctly in other tools (Slang, Verilator, Icarus)

## Environment

- **CIRCT Version**: 1.139.0
- **Tool Chain**: circt-verilog → arcilator → opt → llc
- **OS**: Linux
- **Architecture**: x86_64

## Workaround

Fully initialize all packed struct fields in the same `always_comb` block to avoid the partial assignment pattern:

```systemverilog
module M(output logic O);
  typedef struct packed { logic a; logic b; } S;
  S s;
  always_comb begin
    s.a = 0;  // Initialize unassigned field
    s.b = 0;
  end
  assign O = s.a;
endmodule
```

## Related Issues

- **#8860** [LLHD] Assigning array elements individually creates a combinational loop (CLOSED)
  - Very similar issue for `hw.array_inject` operations
  - Fixed via canonicalizers for arrays, suggesting struct_inject needs similar treatment
- **#5053** [Arc] LowerState: combinatorial cycle reported in cases where there is none (CLOSED)
  - False cycle detection in LowerState pass
- **#6373** [Arc] Support hw.wires of aggregate types (OPEN)
  - Broader tracking of aggregate type support issues in arcilator
- **#8286** [circt-verilog][llhd][arcilator] Verilog-to-LLVM lowering issues (OPEN)
  - General lowering pipeline issues

## Recommendations

1. **Immediate**: Enhance `hw.struct_inject` canonicalizer to detect and eliminate partial assignment cycles, similar to the fix for `hw.array_inject` in #8860
2. **Medium**: Add iteration limit or timeout detection in LowerState worklist processing to catch infinite loops
3. **Medium**: Improve cycle detection to identify false combinational loops from partial struct updates
4. **Long-term**: Ensure all aggregate types (arrays, structs) have consistent canonicalizer coverage

## Validation

This test case has been validated as:
- ✅ Valid SystemVerilog (Slang: 0 errors, 0 warnings)
- ✅ Compatible with Verilator (warnings only - expected for partial usage)
- ✅ Compatible with Icarus Verilog
- ✅ Not a design limitation - this is a genuine bug
- ✅ Minimal reproducer (82% reduction from original)

---
*This issue was generated with assistance from an automated bug reporter.*
