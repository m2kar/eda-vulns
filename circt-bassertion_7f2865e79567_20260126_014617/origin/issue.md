# [arcilator] Assertion failure in LowerState when processing inout port read in always_ff

## Summary

Arcilator crashes with an assertion failure when processing a SystemVerilog module that reads from an `inout wire` port inside an `always_ff` block. The LowerState pass attempts to create an Arc `StateType` from an LLHD reference type (`!llhd.ref<i1>`), which fails verification because reference types don't have a known bit width.

**Status**: This bug was observed in CIRCT 1.139.0 and appears to be **fixed** in newer versions (tested with LLVM 22.0.0git / firtool-1.139.0).

## Environment

- **Original CIRCT Version**: 1.139.0
- **Current Test Version**: LLVM 22.0.0git, CIRCT firtool-1.139.0
- **Tool**: arcilator
- **Reproducibility**: Not reproducible with current version (likely fixed)

## Reproduction

### Test Case (bug.sv)

```systemverilog
module MixedPorts(
  input logic a,
  output logic b,
  inout wire c,
  input logic clk
);

  logic [3:0] temp_reg;

  // Sized decimal constant assignment to output
  assign b = 4'd2;

  // Always block using inout port and clock
  always_ff @(posedge clk) begin
    temp_reg <= c;
  end

  // Bidirectional assignment for inout port
  assign c = a ? temp_reg : 4'bz;

endmodule
```

### Command (original)

```bash
circt-verilog --ir-hw bug.sv | arcilator
```

### Error Output (CIRCT 1.139.0)

```
<unknown>:0: error: state type must have a known bit width; got '!llhd.ref<i1>'
arcilator: .../mlir/include/mlir/IR/StorageUniquerSupport.h:180: Assertion `succeeded(ConcreteT::verifyInvariants(...))' failed.
```

### Stack Trace

```
#12 circt::arc::StateType::get(mlir::Type) ArcTypes.cpp.inc:108
#13 (anonymous namespace)::ModuleLowering::run() LowerState.cpp:219
#15 (anonymous namespace)::LowerStatePass::runOnOperation() LowerState.cpp:1198
```

## Root Cause Analysis

### Crash Location

- **File**: `lib/Dialect/Arc/Transforms/LowerState.cpp`
- **Function**: `ModuleLowering::run()`
- **Line**: 219

### Mechanism

1. The test case uses an `inout wire c` port read in an `always_ff` block
2. `circt-verilog` converts the inout port to an LLHD reference type (`!llhd.ref<i1>`)
3. When arcilator's `LowerState` pass processes the module, it calls `StateType::get(arg.getType())` at line 219
4. `StateType::verify()` invokes `computeLLVMBitWidth()` which doesn't handle LLHD ref types
5. The verification fails with "state type must have a known bit width"

### Key Constructs Triggering the Bug

- `inout wire` port declaration
- Reading from inout port in `always_ff` block
- Tri-state assignment (`assign c = a ? temp_reg : 4'bz`)

## Validation

| Tool | Result | Notes |
|------|--------|-------|
| Verilator | Success | Width warnings (expected) |
| Slang | Success | Parse-only mode, 1800-2023 |
| Current arcilator | Success | Bug appears fixed |

The test case is **valid SystemVerilog** and passes syntax validation with multiple tools.

## Duplicate Check

No existing issues found matching:
- "StateType bit width"
- "arcilator LowerState"
- "inout arcilator"
- "state type must have a known bit width"

## Suggested Fix (if not already fixed)

Handle LLHD reference types in `LowerState` by extracting the element type before creating `StateType`:

```cpp
// In LowerState.cpp, around line 219
Type argType = arg.getType();
if (auto refType = dyn_cast<llhd::RefType>(argType)) {
  argType = refType.getElementType();
}
auto state = StateType::get(argType);
```

Alternatively, reject inout ports earlier with a clear error message instead of an assertion failure.

## Labels

- `arcilator`
- `Arc dialect`
- `LowerState`
- `inout`
- `crash`

## Additional Notes

This issue was discovered through fuzzing with FeatureFuzz-SV. The crash may have been silently fixed as part of other LLHD/Arc improvements. If this is a known fix, it would be helpful to add a regression test to prevent future regressions.

---

*Auto-generated by CIRCT Bug Reporter workflow*
*Crash ID: circt-bassertion_7f2865e79567_20260126_014617*
