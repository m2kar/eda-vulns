<!-- 
  CIRCT Bug Report
  Generated by circt-bug-reporter skill
-->

<!-- Title: [Arc] Assertion failure in LowerState: state type must have a known bit width; got '!llhd.ref<i1>' -->

## Description

The bug occurs in `arcilator` during the `LowerState` pass when processing SystemVerilog modules with `inout` ports using tri-state buffers. The compiler fails to properly handle LLHD reference type (`!llhd.ref<i1>`) generated for these ports, causing an assertion failure because state types must have known bit widths.

**Crash Type**: assertion
**Dialect**: Arc
**Failing Pass**: LowerState

**Status Note**: This bug appears to have been fixed in the current toolchain (LLVM 22.0.0git, CIRCT firtool-1.139.0). The same test case now compiles successfully. This report is provided for historical documentation and regression testing.

## Steps to Reproduce

1. Save the test case below as `test.sv`
2. Run:
   ```bash
   circt-verilog --ir-hw test.sv | arcilator
   ```

Note: In CIRCT 1.139.0 with older LLVM, this would trigger the assertion. In current toolchain, it compiles successfully.

## Test Case

```systemverilog
module combined_mod(
  input logic signed [7:0] in,
  input logic [63:0] wide_input,
  output logic [31:0] out_val,
  inout logic io_sig,
  output logic signed [7:0] out
);

  // Shift operation inside a loop
  always_comb begin
    for (int i = 0; i < 8; i++) begin
      out = in << i;
    end
  end

  // Connect output value from wide input
  assign out_val = wide_input[31:0];

  // Tri-state buffer for inout port
  assign io_sig = (wide_input[0]) ? out[0] : 1'bz;

endmodule
```

## Error Output

```
Crash Type: assertion
Testcase ID: 260128-00001270

--- Compilation Command ---
/edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/circt-verilog --ir-hw /tmp/featurefuzz_sv_xfhtv50x/test_3f24f13e67f2.sv | /edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/arcilator | /edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/opt -O0 | /edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/llc -O0 --filetype=obj -o /tmp/featurefuzz_sv_xfhtv50x/test_3f24f13e67f2.o

--- Error Message ---
<unknown>:0: error: state type must have a known bit width; got '!llhd.ref<i1>'
arcilator: .../StorageUniquerSupport.h:180: static ConcreteT mlir::detail::StorageUserBase<...>::get(...): Assertion `succeeded( ConcreteT::verifyInvariants(getDefaultDiagnosticEmitFn(ctx), args...))' failed.
PLEASE submit a bug report to https://github.com/llvm/llvm-project/issues/ and include the crash backtrace and instructions to reproduce the bug.
```

## Root Cause Analysis

### Hypothesis 1 (High Confidence)
**Cause**: Incomplete handling of LLHD reference types in Arc dialect's StateType verification.

**Evidence**:
- Error message explicitly states "state type must have a known bit width"
- Crash occurs in `StateType::get()` during verification
- `!llhd.ref<i1>` is an LLHD reference type used for hardware signals that don't have a fixed bit width in the traditional sense
- Test case uses an `inout` port with tri-state, which is represented as an LLHD reference

**Mechanism**:
1. The `LowerState` pass calls `StateType::get()` with LLHD reference type
2. `StateType::verifyInvariants()` checks if the type has a known bit width
3. LLHD reference types (`!llhd.ref<T>`) don't have a fixed bit width representation
4. The verification fails, causing assertion

### Test Case Validity
âœ… The test case is valid SystemVerilog and uses only standard, supported features. It represents a real hardware design pattern (bidirectional signals with tri-state control).

## Environment

- **CIRCT Version**: LLVM 22.0.0git, CIRCT firtool-1.139.0 (bug was in older CIRCT 1.139.0)
- **OS**: Linux
- **Architecture**: x86_64

## Stack Trace

<details>
<summary>Click to expand stack trace</summary>

```
Stack dump:
0.	Program arguments: /edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/arcilator
 #0 0x000055afff16123f llvm::sys::PrintStackTrace(llvm::raw_ostream&, int)
 #1 0x000055afff162379 llvm::sys::RunSignalHandlers()
 #2 0x000055afff162379 SignalHandler(int, siginfo_t*, void*)
 #3 0x00007f2342f84330 (/lib/x86_64-linux-gnu/libc.so.6+0x45330)
 #4 0x00007f2342fddb2c __pthread_kill_implementation ./nptl/pthread_kill.c:44:76
 #5 0x00007f2342fddb2c __pthread_kill_internal ./nptl/pthread_kill.c:78:10
 #6 0x00007f2342fddb2c pthread_kill ./nptl/pthread_kill.c:89:10
 #7 0x00007f2342f8427e raise ./signal/../sysdeps/posix/raise.c:27:6
 #8 0x00007f2342f678ff abort ./stdlib/abort.c:81:7
 #9 0x00007f2342f6781b _nl_load_domain ./intl/loadmsgcat.c:1177:9
#10 0x00007f2342f7a517 (/lib/x86_64-linux-gnu/libc.so.6+0x3b517)
#11 0x000055afff8b2bbc (/edazz/FeatureFuzz-SV/target/circt-1.139.0/bin/arcilator+0x7dd5bbc)
#12 0x000055afff8b2ae9 circt::arc::StateType::get(mlir::Type)
    .../ArcTypes.cpp.inc:108:3
#13 0x000055afff91df5c (anonymous namespace)::ModuleLowering::run()
    .../lib/Dialect/Arc/Transforms/LowerState.cpp:219:66
#14 0x000055afff91df5c (anonymous namespace)::LowerStatePass::runOnOperation()
    .../lib/Dialect/Arc/Transforms/LowerState.cpp:1198:41
...
```

</details>

## Related Issues

- #8825: [LLHD] Switch from hw.inout to a custom signal reference type (related to inout port handling)
- #9467: [circt-verilog][arcilator] `arcilator` fails to lower `llhd.constant_time` (related LLHD type issue)
- #4916: [Arc] LowerState: nested arc.state get pulled in wrong clock tree (related LowerState pass issue)

## Suggested Fix Directions

### Option 1: Allow LLHD Reference Types in StateType
Modify `StateType::verifyInvariants()` to properly handle LLHD reference types by adding special case handling for `!llhd.ref<T>` types, extracting the underlying type's bit width or allowing references without bit width constraints.

### Option 2: Add Type Conversion Before LowerState
Introduce a new pass that converts LLHD reference types to types with known bit widths before the `LowerState` pass runs. Create a `LowerLLHDRefs` pass that converts `!llhd.ref<i1>` to appropriate HW types.

### Option 3: Special Handling for inout Ports
Add special handling in SystemVerilog to Arc conversion to handle `inout` ports without generating LLHD reference types, converting them to separate input/output ports with additional control signals.

## Keywords for Search
`arcilator`, `StateType`, `LLHD reference`, `inout port`, `tri-state`, `verifyInvariants`, `LowerState pass`, `!llhd.ref<i1>`, `bit width`

---
*This issue was generated with assistance from an automated bug reporter.*
